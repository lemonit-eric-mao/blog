---
title: 'TiDB 事务冲突测试案例-乐观锁模式'
date: '2020-01-13T01:38:59+00:00'
status: publish
permalink: /2020/01/13/tidb-%e4%ba%8b%e5%8a%a1%e5%86%b2%e7%aa%81%e6%b5%8b%e8%af%95%e6%a1%88%e4%be%8b-%e4%b9%90%e8%a7%82%e9%94%81%e6%a8%a1%e5%bc%8f
author: 毛巳煜
excerpt: ''
type: post
id: 5225
category:
    - TiDB
tag: []
post_format: []
hestia_layout_select:
    - sidebar-right
---
###### 前置条件

**执行SQL的客户端地址**: 172.168.180.46  
**执行SQL的客户端地址**: 172.168.180.47  
**TiDB-Server**: 172.168.180.47

- - - - - -

###### 创建数据库

```sql
CREATE DATABASE eric;

USE eric;

DROP TABLE table1;

# 创建表
CREATE TABLE `table1` (
  `id` bigint(20) NOT NULL,
  `name` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;

# 插入数据
INSERT INTO table1(id, name) VALUES (1000, '张三'), (2000, 'PingCAP');

# 查看
mysql> SELECT * FROM table1;
+------+---------+
| id   | name    |
+------+---------+
| 1000 | 张三    |
| 2000 | PingCAP |
+------+---------+
2 rows in set (0.00 sec)

mysql>

```

##### 测试更新数据冲突

**`关闭`了乐观锁`事务重试`**  
`SET GLOBAL tidb_disable_txn_auto_retry = 1;`

<table><thead><tr><th><label style="width:450px;">事务一</label></th><th align="center"><label style="width:50px;">步骤</label></th><th><label style="width:450px;">事务二</label></th></tr></thead><tbody><tr><td>172.168.180.46</td><td align="center"></td><td>172.168.180.47</td></tr><tr><td>准备数据查询结果 `name='张三'`</td><td align="center">0</td><td>准备数据查询结果 `name='张三'`</td></tr><tr><td>BEGIN;</td><td align="center">**1**</td><td>BEGIN;</td></tr><tr><td>`UPDATE table1 SET name='TiDB' WHERE id = 1000;`</td><td align="center">**2**</td><td></td></tr><tr><td>查询结果 `name='TiDB'`</td><td align="center">**3**</td><td>查询结果 `name='张三'`</td></tr><tr><td></td><td align="center">**4**</td><td>`UPDATE table1 SET name='TUG' WHERE id = 1000;`</td></tr><tr><td>查询结果 `name='TiDB'`</td><td align="center">**5**</td><td>查询结果 `name='TUG'`</td></tr><tr><td>COMMIT;</td><td align="center">**6**</td><td></td></tr><tr><td>查询结果 `name='TiDB'`</td><td align="center">**7**</td><td>查询结果 `name='TUG'`</td></tr><tr><td></td><td align="center">**8**</td><td>COMMIT;</td></tr><tr><td></td><td align="center">**9**</td><td>发生异常写写冲突：  
 `ERROR 9007 (HY000): Write conflict,`   
 `txnStartTS=413963720372256769,`   
 `conflictStartTS=413963719952826370,`  
 `conflictCommitTS=413963759746285570,`   
 `key={tableID=54, handle=1000}`   
 `primary={tableID=54, handle=1000}`   
 `[try again later]`</td></tr></tbody></table>

- - - - - -

- - - - - -

- - - - - -

##### 测试更新数据冲突

**`开启`了乐观锁`事务重试`**  
`SET GLOBAL tidb_disable_txn_auto_retry = 0;`

<table><thead><tr><th><label style="width:450px;">事务一</label></th><th align="center"><label style="width:50px;">步骤</label></th><th><label style="width:450px;">事务二</label></th></tr></thead><tbody><tr><td>172.168.180.46</td><td align="center"></td><td>172.168.180.47</td></tr><tr><td>准备数据查询结果 `name='张三'`</td><td align="center">0</td><td>准备数据查询结果 `name='张三'`</td></tr><tr><td>BEGIN;</td><td align="center">**1**</td><td>BEGIN;</td></tr><tr><td>`UPDATE table1 SET name='TiDB' WHERE id = 1000;`</td><td align="center">**2**</td><td></td></tr><tr><td>查询结果 `name='TiDB'`</td><td align="center">**3**</td><td>查询结果 `name='张三'`</td></tr><tr><td></td><td align="center">**4**</td><td>`UPDATE table1 SET name='TUG' WHERE id = 1000;`</td></tr><tr><td>查询结果 `name='TiDB'`</td><td align="center">**5**</td><td>查询结果 `name='TUG'`</td></tr><tr><td>COMMIT;</td><td align="center">**6**</td><td></td></tr><tr><td>查询结果 `name='TiDB'`</td><td align="center">**7**</td><td>查询结果 `name='TUG'`</td></tr><tr><td></td><td align="center">**8**</td><td>COMMIT;</td></tr><tr><td>查询结果 `name='TUG'`</td><td align="center">**9**</td><td>查询结果 `name='TUG'`;   
 注意：这里的写冲突异常不会抛给客户端，而是由TiDB自动重试机制捕获，  
 然后`重新执行事务中所有DML`在更新一次</td></tr></tbody></table>

- - - - - -

- - - - - -

- - - - - -