---
title: "k8s 安装 Rancher 2.x 使用 cert-manager 版"
date: "2020-07-16"
categories: 
  - "k8s"
---

###### **[安装 Helm](helm-%e5%ae%89%e8%a3%85-%e4%bd%bf%e7%94%a8 "安装 Helm")**

* * *

* * *

* * *

##### 下面以 安装 rancher 为例

###### **[Rancher 官方文档](https://rancher2.docs.rancher.cn/docs/installation/k8s-install/helm-rancher/_index "Rancher 官方文档")**

```ruby
# 使用国内源
[root@master k8s]# helm repo add rancher-stable http://rancher-mirror.oss-cn-beijing.aliyuncs.com/server-charts/stable

# 查看仓库源
[root@master k8s]# helm repo list
NAME            URL
rancher-stable  http://rancher-mirror.oss-cn-beijing.aliyuncs.com/server-charts/stable
[root@master k8s]#

# 查看要安装的程序
[root@master k8s]# helm search repo rancher
NAME                    CHART VERSION   APP VERSION     DESCRIPTION
rancher-stable/rancher  2.4.5           v2.4.5          Install Rancher Server to manage Kubernetes clu...
[root@master k8s]#

# 下载指定版本
[root@master ~]# helm pull rancher-stable/rancher --version 2.4.4

```

* * *

###### 下载到本地 安装 cert-manager

```ruby
helm repo add jetstack https://charts.jetstack.io
helm repo update

helm pull jetstack/cert-manager --version 0.15.0
tar -zxvf cert-manager-v0.15.0.tgz
curl -L -o cert-manager/cert-manager-crds.yaml https://github.com/jetstack/cert-manager/releases/download/v0.15.0/cert-manager.crds.yaml

kubectl create namespace cert-manager
kubectl apply -f cert-manager/cert-manager-crds.yaml

helm install \
 cert-manager ./cert-manager \
 --namespace cert-manager \
 --version v0.15.0

```

###### 卸载 cert-manager

```ruby
helm uninstall cert-manager --namespace cert-manager
```

* * *

##### 下载到本地 rancher

```ruby
# 下载程序包，到当前目录
helm pull rancher-stable/rancher --version 2.4.4
# 解压
tar -zxvf rancher-2.4.4.tgz
# 创建命名空间
kubectl create namespace cattle-system

helm install rancher ./rancher \
 --namespace cattle-system \
 --set hostname=rancher.my.org
```

```ruby
# 更新配置
[root@master ~]# helm upgrade rancher ./rancher --namespace cattle-system

# 卸载
[root@master ~]# helm uninstall rancher --namespace cattle-system

```

* * *

* * *

* * *

###### 常见问题 因为缺少 Ingress-Controller 导致集群启动失败，这里临时改为开放 NodePort 端口

```yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ template "rancher.fullname" . }}
  labels:
    app: {{ template "rancher.fullname" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
spec:
  type: NodePort
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http

  # 加入 https的解析
  - port: 443
    nodePort: 30443
    targetPort: 443
    protocol: TCP
    name: https

  selector:
    app: {{ template "rancher.fullname" . }}
```

* * *

* * *

* * *

#### **`常见问题`**

###### 问题 dial tcp: lookup xxx.com on 10.96.0.10:53: server misbehaving

```ruby
# 查看问题IP原来是 kube-dns，而 xx.xx.xx.xx:53 端口是 DNS，所以问题原因是 DNS解析相关的问题
[root@master ~]# kubectl get svc -A | grep '10.96.0.10'
kube-system          kube-dns                                  ClusterIP   10.96.0.10       <none>        53/UDP,53/TCP,9153/TCP         5d20h
[root@master ~]#
```

* * *

##### DNS 解析失败

```ruby
[root@master k8s-tools]# cat /etc/resolv.conf
# Generated by NetworkManager
search openstacklocal

# 原因：创建大连云虚拟机时，会默认生成 客户DNS，导致域名解析失败
# nameserver 11.11.11.3    # 删除客户DNS

nameserver 223.5.5.5
nameserver 223.6.6.6
[root@master k8s-tools]#
```

* * *
