---
title: "Traefik-æ’ä»¶å¼€å‘"
date: "2025-04-27"
categories: 
  - "Traefik"
---

# Traefik æ’ä»¶å¼€å‘



``` mermaid
sequenceDiagram
    participant Client
    participant Traefik
    participant Plugin
    participant ModelServer
    participant FastAPI

    Client->>Traefik: å‘é€è¯·æ±‚ï¼ˆå« promptï¼‰
    Traefik->>Plugin: è¿›å…¥æ’ä»¶ä¸­é—´ä»¶
    Plugin->>ModelServer: è½¬å‘è¯·æ±‚åˆ°æ¨¡å‹æœåŠ¡
    ModelServer-->>Plugin: è¿”å›å“åº”ï¼ˆå« replyï¼‰

    Plugin->>FastAPI: å¼‚æ­¥å‘é€ input + output å†…å®¹
    Plugin-->>Client: å°†å“åº”åŸæ ·è¿”å›
    FastAPI->>FastAPI: è®¡ç®— token / time
    FastAPI->>SQLite: æŒä¹…åŒ–ç»Ÿè®¡æ•°æ®

```



### 

------

### ğŸ§© 1. **Traefik æ’ä»¶ - è½»é‡é‡‡é›†å™¨**

ä»…æ‹¦æˆªæ¨¡å‹æ¥å£æµé‡ï¼ŒæŠŠè¯·æ±‚/å“åº”åŸå§‹æ•°æ®æ‰“åŒ…ä¸º JSONï¼Œå¼‚æ­¥å‘é€ç»™ FastAPIï¼Œä¸åšä»»ä½•ä¸šåŠ¡è§£æã€‚

------

### ğŸš€ 2. **FastAPI æœåŠ¡ç«¯ - æ™ºèƒ½åˆ†æå™¨**

æ¥æ”¶åŸå§‹æ•°æ®ï¼Œè®¡ç®— token æ•°é‡ã€é€Ÿç‡ã€è€—æ—¶ï¼Œå­˜å…¥ SQLiteï¼ŒåŒæ—¶å…·å¤‡å¯æ‰©å±•æ€§ï¼ˆå¯ç”¨äºå°†æ¥åšè®¡è´¹ã€é™æµç­‰ï¼‰ã€‚







------

# ğŸ”§ 1. Traefik æ’ä»¶å¼€å‘ï¼ˆè½»é‡ç‰ˆï¼‰

---



### ğŸ“ é¡¹ç›®ç»“æ„ `llmtoken/`

```yaml
llmtoken/
â”œâ”€â”€ go.mod
â”œâ”€â”€ plugin.go
â””â”€â”€ .traefik.yml         # è¿™ä¸ªæ–‡ä»¶æ˜¯ Traefik ç”¨æ¥è¯†åˆ«ä½ çš„æ’ä»¶â€œå…ƒä¿¡æ¯â€çš„ï¼Œå®ƒä¸å‚ä¸ Go æ„å»ºï¼Œä½†ç¼ºäº†å°±ä¸è®¤æ’ä»¶ã€‚
```

------

### ğŸ“„ `go.mod`

```go
module github.com/lemonit-eric-mao/llmtoken

go 1.20

```



---

### ğŸ“„ `.traefik.yml`

```yaml
# æ’ä»¶åœ¨ Traefik Pilot é¡µé¢ä¸­æ˜¾ç¤ºçš„åå­—
displayName: Traefik Tokenizer

# æ’ä»¶ç±»å‹ï¼Œç›®å‰ä»…æ”¯æŒ middlewareï¼ˆä¸­é—´ä»¶ï¼‰
type: middleware

# æ’ä»¶çš„å¯¼å…¥è·¯å¾„ï¼Œå¿…é¡»ä¸ go.mod æ–‡ä»¶ä¸­çš„ module å­—æ®µä¸€è‡´
# go.modç”¨çš„ä¹Ÿæ˜¯githubé¡¹ç›®è·¯å¾„ï¼Œhttps://github.com/lemonit-eric-mao/llmtoken
import: github.com/lemonit-eric-mao/llmtoken

# æ’ä»¶çš„ç®€è¦æè¿°
summary: ä¸€ä¸ªç”¨äºåœ¨è¯·æ±‚ä¸­è‡ªåŠ¨æ³¨å…¥ LLM Token çš„ Traefik ä¸­é—´ä»¶æ’ä»¶

# æ’ä»¶æµ‹è¯•æ—¶ä½¿ç”¨çš„é»˜è®¤é…ç½®æ•°æ®ï¼ˆTraefik Pilot ä¼šç”¨è¿™äº›æ•°æ®éªŒè¯æ’ä»¶ï¼‰
testData:
  Token: "test-token"
```

> âœ”ï¸ è¿™ä¸ªæ–‡ä»¶æ˜¯ Traefik ç”¨æ¥è¯†åˆ«ä½ çš„æ’ä»¶â€œå…ƒä¿¡æ¯â€çš„ï¼Œå®ƒä¸å‚ä¸ Go æ„å»ºï¼Œä½†ç¼ºäº†å°±ä¸è®¤æ’ä»¶ã€‚



------

### ğŸ“„ `plugin.go`

```go
package llmtoken

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"time"
)

// Config é…ç½®ç»“æ„ä½“
type Config struct {
	Apiurl string `json:"Apiurl,omitempty"` // æ³¨æ„è¿™é‡Œçš„å‘½åä¸è¦é©¼å³°ï¼Œå¦åˆ™æ’ä»¶åŠ è½½æœ‰é—®é¢˜
}

// CreateConfig åˆ›å»ºé»˜è®¤é…ç½®
func CreateConfig() *Config {
	return &Config{}
}

// TokenPlugin æ’ä»¶ç»“æ„ä½“
type TokenPlugin struct {
	next   http.Handler
	name   string
	Apiurl string
}

// New æ’ä»¶å®ä¾‹åŒ–
func New(ctx context.Context, next http.Handler, config *Config, name string) (http.Handler, error) {
	if config.Apiurl == "" {
		return nil, fmt.Errorf("Apiurl is required")
	}
	return &TokenPlugin{
		next:   next,
		name:   name,
		Apiurl: config.Apiurl,
	}, nil
}

// è¯·æ±‚æ‹¦æˆªå¤„ç†
func (p *TokenPlugin) ServeHTTP(rw http.ResponseWriter, req *http.Request) {
	start := time.Now()

	// è¯»å–è¯·æ±‚ä½“
	reqBody, err := io.ReadAll(req.Body)
	if err != nil {
		http.Error(rw, "failed to read request body", http.StatusInternalServerError)
		return
	}
	req.Body = io.NopCloser(bytes.NewBuffer(reqBody))

	// æ•è·å“åº”ä½“
	rec := &responseRecorder{ResponseWriter: rw, body: &bytes.Buffer{}}
	p.next.ServeHTTP(rec, req)

	// å¼‚æ­¥å‘é€åˆ° FastAPI
	go p.sendToFastAPI(req, reqBody, rec.body.Bytes(), time.Since(start).Seconds())
}

// å“åº”ä½“æ•è·å™¨
type responseRecorder struct {
	http.ResponseWriter
	body *bytes.Buffer
}

func (r *responseRecorder) Write(b []byte) (int, error) {
	r.body.Write(b)
	return r.ResponseWriter.Write(b)
}

// RawPayload ä¸ŠæŠ¥çš„æ•°æ®ç»“æ„
type RawPayload struct {
	RequestBody  string  `json:"request_body"`
	ResponseBody string  `json:"response_body"`
	ElapsedTime  float64 `json:"elapsed_time"`
	Path         string  `json:"path"`
	Timestamp    string  `json:"timestamp"`
}

// å¼‚æ­¥å‘é€è¯·æ±‚
func (p *TokenPlugin) sendToFastAPI(req *http.Request, reqBody, resBody []byte, elapsed float64) {
	payload := RawPayload{
		RequestBody:  string(reqBody),
		ResponseBody: string(resBody),
		ElapsedTime:  elapsed,
		Path:         req.URL.Path,
		Timestamp:    time.Now().Format(time.RFC3339),
	}

	data, err := json.Marshal(payload)
	if err != nil {
		fmt.Printf("failed to marshal payload: %v\n", err)
		return
	}

	resp, err := http.Post(p.Apiurl, "application/json", bytes.NewBuffer(data))
	if err != nil {
		fmt.Printf("failed to send payload: %v\n", err)
		return
	}
	defer resp.Body.Close()
}

```







------

# ğŸ”§ 2. Traefik æ’ä»¶åŠ è½½

------



[å‚è€ƒæ–‡ç« ](https://plugins.traefik.io/plugins/628c9ee2108ecc83915d7764/demo-plugin)



### ğŸ§© ä¸€ã€ç›®å½•ç»“æ„è¦æ±‚ï¼ˆé‡è¦ï¼‰

è¯·æŠŠæ’ä»¶æºç æ”¾åœ¨ä»¥ä¸‹è·¯å¾„ï¼ˆå’Œ `docker-compose.yml` åŒå±‚ï¼‰ï¼š

```
.
â”œâ”€â”€ docker-compose.yml             ğŸ‘ˆ Docker Compose å¯åŠ¨æ–‡ä»¶
â”œâ”€â”€ config/                         ğŸ‘ˆ Traefik é…ç½®ç›®å½•
â”‚   â”œâ”€â”€ traefik.yml                 ğŸ‘ˆ Traefik ä¸»é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ dynamic/                    ğŸ‘ˆ åŠ¨æ€é…ç½®ç›®å½•ï¼ˆå¯é€‰ç”¨ï¼‰
â””â”€â”€ plugins-local/                  ğŸ‘ˆ æœ¬åœ°æ’ä»¶ç›®å½•ï¼ˆå›ºå®šè·¯å¾„ï¼‰
    â””â”€â”€ src                         
        â””â”€â”€ github.com
            â””â”€â”€ lemonit-eric-mao     ğŸ‘ˆ GitHub ç”¨æˆ·å
                â””â”€â”€ llmtoken         ğŸ‘ˆ é¡¹ç›®åï¼ˆæ’ä»¶åï¼‰
                    â”œâ”€â”€ .traefik.yml ğŸ‘ˆ æ’ä»¶çš„ Traefik é…ç½®æ–‡ä»¶
                    â”œâ”€â”€ go.mod       ğŸ‘ˆ Go æ¨¡å—å®šä¹‰æ–‡ä»¶
                    â””â”€â”€ llmtoken.go  ğŸ‘ˆ æ’ä»¶æºç 

```

> âš ï¸ æ³¨æ„ï¼š`src` ä¸‹é¢çš„ç»“æ„å¿…é¡»ç²¾ç¡®åŒ¹é… `moduleName`ã€‚

``` bash
mkdir -p config/dynamic/
mkdir -p plugins-local/src/github.com/lemonit-eric-mao/llmtoken/
```

#### ğŸ§ª ä¸‹è½½æ’ä»¶

``` bash
git clone https://github.com/lemonit-eric-mao/llmtoken.git plugins-local/src/github.com/lemonit-eric-mao/llmtoken/
```







------

### ğŸ›  äºŒã€ä¿®æ”¹ `docker-compose.yaml` âœ…

```yaml
version: '3.6'

services:
  traefik-server:
    container_name: traefik-server
    image: traefik:v3.2.0
    command:
      - --providers.docker  # å¯ç”¨ Docker ä½œä¸ºæœåŠ¡æä¾›è€…
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config:/etc/traefik                     # âœ… æŒ‚è½½é…ç½®ç›®å½•
      - ./plugins-local:/plugins-local            # âœ… æŒ‚è½½ä½ çš„æ’ä»¶ç›®å½•
```

æ‹‰å–é•œåƒ

``` bash
docker login --username=mao_siyu registry.cn-qingdao.aliyuncs.com

docker pull registry.cn-qingdao.aliyuncs.com/cn-aliyun/traefik:v3.2.0

docker tag registry.cn-qingdao.aliyuncs.com/cn-aliyun/traefik:v3.2.0 traefik:v3.2.0
```



------



### ğŸ§© é…ç½®æ–‡ä»¶æ‹†åˆ†è¯´æ˜



| ç±»å‹     | ä½ç½®                           | æ–‡ä»¶å        | å†…å®¹                                            |
| -------- | ------------------------------ | ------------- | ----------------------------------------------- |
| é™æ€é…ç½® | `./config/traefik.yml`         | `traefik.yml` | entryPointsã€providersã€logã€plugins ç­‰æ ¸å¿ƒé…ç½® |
| åŠ¨æ€é…ç½® | `./config/dynamic/routers.yml` | `routers.yml` | middlewaresã€routersã€services ç­‰               |



### âœï¸ ä¸‰ã€traefik.yml å†…å®¹ä¿®æ”¹ï¼ˆå¯ç”¨æ’ä»¶ï¼‰

ğŸ“„ `config/traefik.yml`ï¼ˆé™æ€é…ç½®ï¼‰

```yaml
entryPoints:
  web:
    address: ":80"

api:
  dashboard: true
  insecure: true

log:
  level: INFO

ping:
  entryPoint: web

providers:
  file:
    directory: /etc/traefik/dynamic                         # âœ… åŠ¨æ€çƒ­æ›´æ–°ç›®å½•
    watch: true

experimental:
  localPlugins:                                             # æ¥ä¸‹æ¥ä¼šåŠ è½½æœ¬åœ°æ’ä»¶
    llmtoken:                                               # æ’ä»¶åï¼ˆé€šå¸¸ä½¿ç”¨æ’ä»¶çš„åŒ…åï¼‰
      moduleName: github.com/lemonit-eric-mao/llmtoken      # æœ¬åœ°æ’ä»¶è·¯å¾„ï¼ˆé€šå¸¸ä¸é…ç½®æ–‡ä»¶importã€go.modçš„ modelåä¸€æ ·ï¼‰

```

> âœ… æ³¨æ„è¿™é‡Œæ˜¯ `localPlugins`ï¼ˆä¸æ˜¯ `plugins`ï¼‰ï¼ŒTraefik v3 è¯†åˆ«çš„å…³é”®å­—æ®µã€‚



ğŸ“„ `config/dynamic/routers.yml`ï¼ˆåŠ¨æ€é…ç½®ï¼‰

``` yaml
http:

  middlewares:
    tokenizer:                                              # æ’ä»¶çš„åˆ«åï¼Œæä¾›ç»™è·¯ç”±å¼•ç”¨çš„åç§°
      plugin:
        llmtoken:                                           # æ’ä»¶çš„åˆ«åå¯¹åº”ç»‘å®šçš„å¯¹åº”æ’ä»¶å
          apiurl: "http://10.119.163.202:8000/api/report"   # æ”¶é›†Tokençš„FastAPI WebæœåŠ¡å™¨

  routers:
    router-default:
      rule: "HeaderRegexp(`X-Model`, `^*$`)"
      service: service-default
      priority: 1

    router-qwen2:
      rule: "Header(`X-Model`, `qwen2.5-vl-instruct`)"
      service: service-qwen2
      middlewares:
        - tokenizer                                         # æ’ä»¶çš„åˆ«å

  services:
    service-default:
      loadBalancer:
        servers:
          - url: http://10.119.163.202:9997
        passHostHeader: false

    service-qwen2:
      loadBalancer:
        servers:
          - url: http://10.119.163.202:9997
        passHostHeader: false
```





------

### ğŸ§ª å››ã€å¯åŠ¨å¹¶éªŒè¯æ’ä»¶

```bash
docker-compose down

docker-compose up --build
```

è§‚å¯Ÿ Traefik æ—¥å¿—ï¼Œç¡®ä¿çœ‹åˆ°ï¼š

```
Plugin token loaded
```

æˆ–æŸ¥çœ‹ `http://localhost:8080/dashboard/` çœ‹æ’ä»¶æ˜¯å¦å¯ç”¨ã€‚

------

### ğŸ§  æ¸©é¦¨æé†’

| è¦ç‚¹               | å†…å®¹                                      |
| ------------------ | ----------------------------------------- |
| æ’ä»¶ç›®å½•           | ä¸€å®šè¦æœ¬åœ°æœ‰ ` plugins-local/src`         |
| `go.mod` æ¨¡å—å    | è¦ä¸ `traefik.yml` ä¸­çš„ `moduleName` ä¸€è‡´ |
| ä¸éœ€è¦è‡ªå·±æ„å»ºæ’ä»¶ | Traefik ä¼šè‡ªåŠ¨åœ¨å¯åŠ¨æ—¶æ„å»º                |

------



## 







------

# ğŸ”§ 3. FastAPI æœåŠ¡ç«¯å¼€å‘ï¼ˆToken åˆ†æ & SQLite å­˜å‚¨ï¼‰

---



### ğŸ“ é¡¹ç›®ç»“æ„ `fastapi-token-tracker/`

```
fastapi-token-tracker/
â”œâ”€â”€ main.py
â”œâ”€â”€ models.py
â”œâ”€â”€ database.py
â”œâ”€â”€ token_utils.py
â”œâ”€â”€ requirements.txt
```

------

### ğŸ“„ `requirements.txt`

```
fastapi
uvicorn
sqlalchemy
tiktoken
```

------

### ğŸ“„ `database.py`

```python
from sqlalchemy import create_engine, Column, Integer, Float, Text, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "sqlite:///./token_stats.db"

engine = create_engine(DATABASE_URL, connect_args={"check_same_thread": False})
SessionLocal = sessionmaker(bind=engine)
Base = declarative_base()

class TokenStat(Base):
    __tablename__ = "token_stats"

    id = Column(Integer, primary_key=True, index=True)
    input_tokens = Column(Integer)
    output_tokens = Column(Integer)
    total_tokens = Column(Integer)
    elapsed_time = Column(Float)
    tokens_per_second = Column(Float)
    timestamp = Column(String)
    path = Column(String)
    request_body = Column(Text)
    response_body = Column(Text)

Base.metadata.create_all(bind=engine)
```

------

### ğŸ“„ `token_utils.py`

```python
import json
import tiktoken

def count_tokens_from_messages(messages, model="gpt-3.5-turbo"):
    try:
        encoding = tiktoken.encoding_for_model(model)
    except:
        encoding = tiktoken.get_encoding("cl100k_base")

    num_tokens = 0
    for msg in messages:
        num_tokens += 4
        for key, val in msg.items():
            num_tokens += len(encoding.encode(val))
    num_tokens += 2
    return num_tokens

def count_output_tokens(text: str, model="gpt-3.5-turbo"):
    try:
        encoding = tiktoken.encoding_for_model(model)
    except:
        encoding = tiktoken.get_encoding("cl100k_base")
    return len(encoding.encode(text))
```

------

### ğŸ“„ `main.py`

```python
from fastapi import FastAPI, Request, Depends
from sqlalchemy.orm import Session
from database import SessionLocal, TokenStat
from token_utils import count_tokens_from_messages, count_output_tokens
import json

app = FastAPI()

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.post("/api/report")
async def track(request: Request, db: Session = Depends(get_db)):
    data = await request.json()

    request_body = data["request_body"]
    response_body = data["response_body"]
    elapsed_time = data["elapsed_time"]
    timestamp = data.get("timestamp")
    path = data.get("path")

    # å°è¯•ä»è¯·æ±‚ä¸­æå– messages
    input_tokens = 0
    try:
        request_data = json.loads(request_body)
        messages = request_data.get("messages", [])
        input_tokens = count_tokens_from_messages(messages)
    except Exception:
        messages = []

    # å°è¯•ä»å“åº”ä¸­æå– content
    output_tokens = 0
    try:
        response_data = json.loads(response_body)
        content = response_data["choices"][0]["message"]["content"]
        output_tokens = count_output_tokens(content)
    except Exception:
        content = ""

    total_tokens = input_tokens + output_tokens
    tps = total_tokens / elapsed_time if elapsed_time > 0 else 0

    record = TokenStat(
        input_tokens=input_tokens,
        output_tokens=output_tokens,
        total_tokens=total_tokens,
        elapsed_time=elapsed_time,
        tokens_per_second=tps,
        timestamp=timestamp,
        path=path,
        request_body=request_body,
        response_body=response_body,
    )
    db.add(record)
    db.commit()

    return {"status": "ok", "total_tokens": total_tokens, "tps": tps}


# å¯åŠ¨
if __name__ == "__main__":
    import uvicorn

    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8000
    )

```

------

## âœ… å¯åŠ¨ FastAPI

```bash
python main.py
```

------
