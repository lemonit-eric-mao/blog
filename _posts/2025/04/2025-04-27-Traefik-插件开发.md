---
title: "Traefik-Êèí‰ª∂ÂºÄÂèë"
date: "2025-04-27"
categories: 
  - "Traefik"
---

# Traefik Êèí‰ª∂ÂºÄÂèë



``` mermaid
sequenceDiagram
    participant Client
    participant Traefik
    participant Plugin
    participant ModelServer
    participant FastAPI

    Client->>Traefik: ÂèëÈÄÅËØ∑Ê±ÇÔºàÂê´ promptÔºâ
    Traefik->>Plugin: ËøõÂÖ•Êèí‰ª∂‰∏≠Èó¥‰ª∂
    Plugin->>ModelServer: ËΩ¨ÂèëËØ∑Ê±ÇÂà∞Ê®°ÂûãÊúçÂä°
    ModelServer-->>Plugin: ËøîÂõûÂìçÂ∫îÔºàÂê´ replyÔºâ

    Plugin->>FastAPI: ÂºÇÊ≠•ÂèëÈÄÅ input + output ÂÜÖÂÆπ
    Plugin-->>Client: Â∞ÜÂìçÂ∫îÂéüÊ†∑ËøîÂõû
    FastAPI->>FastAPI: ËÆ°ÁÆó token / time
    FastAPI->>SQLite: ÊåÅ‰πÖÂåñÁªüËÆ°Êï∞ÊçÆ

```



### 

------

### üß© 1. **Traefik Êèí‰ª∂ - ËΩªÈáèÈááÈõÜÂô®**

‰ªÖÊã¶Êà™Ê®°ÂûãÊé•Âè£ÊµÅÈáèÔºåÊääËØ∑Ê±Ç/ÂìçÂ∫îÂéüÂßãÊï∞ÊçÆÊâìÂåÖ‰∏∫ JSONÔºåÂºÇÊ≠•ÂèëÈÄÅÁªô FastAPIÔºå‰∏çÂÅö‰ªª‰Ωï‰∏öÂä°Ëß£Êûê„ÄÇ

------

### üöÄ 2. **FastAPI ÊúçÂä°Á´Ø - Êô∫ËÉΩÂàÜÊûêÂô®**

Êé•Êî∂ÂéüÂßãÊï∞ÊçÆÔºåËÆ°ÁÆó token Êï∞Èáè„ÄÅÈÄüÁéá„ÄÅËÄóÊó∂ÔºåÂ≠òÂÖ• SQLiteÔºåÂêåÊó∂ÂÖ∑Â§áÂèØÊâ©Â±ïÊÄßÔºàÂèØÁî®‰∫éÂ∞ÜÊù•ÂÅöËÆ°Ë¥π„ÄÅÈôêÊµÅÁ≠âÔºâ„ÄÇ







------

# üîß 1. Traefik Êèí‰ª∂ÂºÄÂèëÔºàËΩªÈáèÁâàÔºâ

---



### üìÅ È°πÁõÆÁªìÊûÑ `llmtoken/`

```yaml
llmtoken/
‚îú‚îÄ‚îÄ go.mod
‚îú‚îÄ‚îÄ plugin.go
‚îî‚îÄ‚îÄ .traefik.yml         # Ëøô‰∏™Êñá‰ª∂ÊòØ Traefik Áî®Êù•ËØÜÂà´‰Ω†ÁöÑÊèí‰ª∂‚ÄúÂÖÉ‰ø°ÊÅØ‚ÄùÁöÑÔºåÂÆÉ‰∏çÂèÇ‰∏é Go ÊûÑÂª∫Ôºå‰ΩÜÁº∫‰∫ÜÂ∞±‰∏çËÆ§Êèí‰ª∂„ÄÇ
```

------

### üìÑ `go.mod`

```go
module github.com/lemonit-eric-mao/llmtoken

go 1.20

```



---

### üìÑ `.traefik.yml`

```yaml
# Êèí‰ª∂Âú® Traefik Pilot È°µÈù¢‰∏≠ÊòæÁ§∫ÁöÑÂêçÂ≠ó
displayName: Traefik Tokenizer

# Êèí‰ª∂Á±ªÂûãÔºåÁõÆÂâç‰ªÖÊîØÊåÅ middlewareÔºà‰∏≠Èó¥‰ª∂Ôºâ
type: middleware

# Êèí‰ª∂ÁöÑÂØºÂÖ•Ë∑ØÂæÑÔºåÂøÖÈ°ª‰∏é go.mod Êñá‰ª∂‰∏≠ÁöÑ module Â≠óÊÆµ‰∏ÄËá¥
# go.modÁî®ÁöÑ‰πüÊòØgithubÈ°πÁõÆË∑ØÂæÑÔºåhttps://github.com/lemonit-eric-mao/llmtoken
import: github.com/lemonit-eric-mao/llmtoken

# Êèí‰ª∂ÁöÑÁÆÄË¶ÅÊèèËø∞
summary: ‰∏Ä‰∏™Áî®‰∫éÂú®ËØ∑Ê±Ç‰∏≠Ëá™Âä®Ê≥®ÂÖ• LLM Token ÁöÑ Traefik ‰∏≠Èó¥‰ª∂Êèí‰ª∂

# Êèí‰ª∂ÊµãËØïÊó∂‰ΩøÁî®ÁöÑÈªòËÆ§ÈÖçÁΩÆÊï∞ÊçÆÔºàTraefik Pilot ‰ºöÁî®Ëøô‰∫õÊï∞ÊçÆÈ™åËØÅÊèí‰ª∂Ôºâ
testData:
  Token: "test-token"
```

> ‚úîÔ∏è Ëøô‰∏™Êñá‰ª∂ÊòØ Traefik Áî®Êù•ËØÜÂà´‰Ω†ÁöÑÊèí‰ª∂‚ÄúÂÖÉ‰ø°ÊÅØ‚ÄùÁöÑÔºåÂÆÉ‰∏çÂèÇ‰∏é Go ÊûÑÂª∫Ôºå‰ΩÜÁº∫‰∫ÜÂ∞±‰∏çËÆ§Êèí‰ª∂„ÄÇ



------

### üìÑ `plugin.go`

```go
package llmtoken

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"time"
)

// Config ÈÖçÁΩÆÁªìÊûÑ‰Ωì
type Config struct {
	Apiurl string `json:"Apiurl,omitempty"` // Ê≥®ÊÑèËøôÈáåÁöÑÂëΩÂêç‰∏çË¶ÅÈ©ºÂ≥∞ÔºåÂê¶ÂàôÊèí‰ª∂Âä†ËΩΩÊúâÈóÆÈ¢ò
}

// CreateConfig ÂàõÂª∫ÈªòËÆ§ÈÖçÁΩÆ
func CreateConfig() *Config {
	return &Config{}
}

// TokenPlugin Êèí‰ª∂ÁªìÊûÑ‰Ωì
type TokenPlugin struct {
	next   http.Handler
	name   string
	Apiurl string
}

// New Êèí‰ª∂ÂÆû‰æãÂåñ
func New(ctx context.Context, next http.Handler, config *Config, name string) (http.Handler, error) {
	if config.Apiurl == "" {
		return nil, fmt.Errorf("Apiurl is required")
	}
	return &TokenPlugin{
		next:   next,
		name:   name,
		Apiurl: config.Apiurl,
	}, nil
}

// ËØ∑Ê±ÇÊã¶Êà™Â§ÑÁêÜ
func (p *TokenPlugin) ServeHTTP(rw http.ResponseWriter, req *http.Request) {
	start := time.Now()

	// ËØªÂèñËØ∑Ê±Ç‰Ωì
	reqBody, err := io.ReadAll(req.Body)
	if err != nil {
		http.Error(rw, "failed to read request body", http.StatusInternalServerError)
		return
	}
	req.Body = io.NopCloser(bytes.NewBuffer(reqBody))

	// ÊçïËé∑ÂìçÂ∫î‰Ωì
	rec := &responseRecorder{ResponseWriter: rw, body: &bytes.Buffer{}}
	p.next.ServeHTTP(rec, req)

	// ÂºÇÊ≠•ÂèëÈÄÅÂà∞ FastAPI
	go p.sendToFastAPI(req, reqBody, rec.body.Bytes(), time.Since(start).Seconds())
}

// ÂìçÂ∫î‰ΩìÊçïËé∑Âô®
type responseRecorder struct {
	http.ResponseWriter
	body *bytes.Buffer
}

func (r *responseRecorder) Write(b []byte) (int, error) {
	r.body.Write(b)
	return r.ResponseWriter.Write(b)
}

// RawPayload ‰∏äÊä•ÁöÑÊï∞ÊçÆÁªìÊûÑ
type RawPayload struct {
	RequestBody  string  `json:"request_body"`
	ResponseBody string  `json:"response_body"`
	ElapsedTime  float64 `json:"elapsed_time"`
	Path         string  `json:"path"`
	Timestamp    string  `json:"timestamp"`
}

// ÂºÇÊ≠•ÂèëÈÄÅËØ∑Ê±Ç
func (p *TokenPlugin) sendToFastAPI(req *http.Request, reqBody, resBody []byte, elapsed float64) {
	payload := RawPayload{
		RequestBody:  string(reqBody),
		ResponseBody: string(resBody),
		ElapsedTime:  elapsed,
		Path:         req.URL.Path,
		Timestamp:    time.Now().Format(time.RFC3339),
	}

	data, err := json.Marshal(payload)
	if err != nil {
		fmt.Printf("failed to marshal payload: %v\n", err)
		return
	}

	resp, err := http.Post(p.Apiurl, "application/json", bytes.NewBuffer(data))
	if err != nil {
		fmt.Printf("failed to send payload: %v\n", err)
		return
	}
	defer resp.Body.Close()
}

```







------

# üîß 2. Traefik Êèí‰ª∂Âä†ËΩΩ

------



[ÂèÇËÄÉÊñáÁ´†](https://plugins.traefik.io/plugins/628c9ee2108ecc83915d7764/demo-plugin)



### üß© ‰∏Ä„ÄÅÁõÆÂΩïÁªìÊûÑË¶ÅÊ±ÇÔºàÈáçË¶ÅÔºâ

ËØ∑ÊääÊèí‰ª∂Ê∫êÁ†ÅÊîæÂú®‰ª•‰∏ãË∑ØÂæÑÔºàÂíå `docker-compose.yml` ÂêåÂ±ÇÔºâÔºö

```
.
‚îú‚îÄ‚îÄ docker-compose.yml             üëà Docker Compose ÂêØÂä®Êñá‰ª∂
‚îú‚îÄ‚îÄ config/                         üëà Traefik ÈÖçÁΩÆÁõÆÂΩï
‚îÇ   ‚îú‚îÄ‚îÄ traefik.yml                 üëà Traefik ‰∏ªÈÖçÁΩÆÊñá‰ª∂
‚îÇ   ‚îî‚îÄ‚îÄ dynamic/                    üëà Âä®ÊÄÅÈÖçÁΩÆÁõÆÂΩïÔºàÂèØÈÄâÁî®Ôºâ
‚îî‚îÄ‚îÄ plugins-local/                  üëà Êú¨Âú∞Êèí‰ª∂ÁõÆÂΩïÔºàÂõ∫ÂÆöË∑ØÂæÑÔºâ
    ‚îî‚îÄ‚îÄ src                         
        ‚îî‚îÄ‚îÄ github.com
            ‚îî‚îÄ‚îÄ lemonit-eric-mao     üëà GitHub Áî®Êà∑Âêç
                ‚îî‚îÄ‚îÄ llmtoken         üëà È°πÁõÆÂêçÔºàÊèí‰ª∂ÂêçÔºâ
                    ‚îú‚îÄ‚îÄ .traefik.yml üëà Êèí‰ª∂ÁöÑ Traefik ÈÖçÁΩÆÊñá‰ª∂
                    ‚îú‚îÄ‚îÄ go.mod       üëà Go Ê®°ÂùóÂÆö‰πâÊñá‰ª∂
                    ‚îî‚îÄ‚îÄ llmtoken.go  üëà Êèí‰ª∂Ê∫êÁ†Å

```

> ‚ö†Ô∏è Ê≥®ÊÑèÔºö`src` ‰∏ãÈù¢ÁöÑÁªìÊûÑÂøÖÈ°ªÁ≤æÁ°ÆÂåπÈÖç `moduleName`„ÄÇ

``` bash
mkdir -p config/dynamic/
mkdir -p plugins-local/src/github.com/lemonit-eric-mao/llmtoken/
```

#### üß™ ‰∏ãËΩΩÊèí‰ª∂

``` bash
git clone https://github.com/lemonit-eric-mao/llmtoken.git plugins-local/src/github.com/lemonit-eric-mao/llmtoken/
```







------

### üõ† ‰∫å„ÄÅ‰øÆÊîπ `docker-compose.yaml` ‚úÖ

```yaml
version: '3.6'

services:
  traefik-server:
    container_name: traefik-server
    image: traefik:v3.2.0
    command:
      - --providers.docker  # ÂêØÁî® Docker ‰Ωú‰∏∫ÊúçÂä°Êèê‰æõËÄÖ
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config:/etc/traefik                     # ‚úÖ ÊåÇËΩΩÈÖçÁΩÆÁõÆÂΩï
      - ./plugins-local:/plugins-local            # ‚úÖ ÊåÇËΩΩ‰Ω†ÁöÑÊèí‰ª∂ÁõÆÂΩï
```

ÊãâÂèñÈïúÂÉè

``` bash
docker login --username=mao_siyu registry.cn-qingdao.aliyuncs.com

docker pull registry.cn-qingdao.aliyuncs.com/cn-aliyun/traefik:v3.2.0

docker tag registry.cn-qingdao.aliyuncs.com/cn-aliyun/traefik:v3.2.0 traefik:v3.2.0
```



------



### üß© ÈÖçÁΩÆÊñá‰ª∂ÊãÜÂàÜËØ¥Êòé



| Á±ªÂûã     | ‰ΩçÁΩÆ                           | Êñá‰ª∂Âêç        | ÂÜÖÂÆπ                                            |
| -------- | ------------------------------ | ------------- | ----------------------------------------------- |
| ÈùôÊÄÅÈÖçÁΩÆ | `./config/traefik.yml`         | `traefik.yml` | entryPoints„ÄÅproviders„ÄÅlog„ÄÅplugins Á≠âÊ†∏ÂøÉÈÖçÁΩÆ |
| Âä®ÊÄÅÈÖçÁΩÆ | `./config/dynamic/routers.yml` | `routers.yml` | middlewares„ÄÅrouters„ÄÅservices Á≠â               |



### ‚úèÔ∏è ‰∏â„ÄÅtraefik.yml ÂÜÖÂÆπ‰øÆÊîπÔºàÂêØÁî®Êèí‰ª∂Ôºâ

üìÑ `config/traefik.yml`ÔºàÈùôÊÄÅÈÖçÁΩÆÔºâ

```yaml
entryPoints:
  web:
    address: ":80"

api:
  dashboard: true
  insecure: true

log:
  level: INFO

ping:
  entryPoint: web

providers:
  file:
    directory: /etc/traefik/dynamic                         # ‚úÖ Âä®ÊÄÅÁÉ≠Êõ¥Êñ∞ÁõÆÂΩï
    watch: true

experimental:
  localPlugins:                                             # Êé•‰∏ãÊù•‰ºöÂä†ËΩΩÊú¨Âú∞Êèí‰ª∂
    llmtoken:                                               # Êèí‰ª∂ÂêçÔºàÈÄöÂ∏∏‰ΩøÁî®Êèí‰ª∂ÁöÑÂåÖÂêçÔºâ
      moduleName: github.com/lemonit-eric-mao/llmtoken      # Êú¨Âú∞Êèí‰ª∂Ë∑ØÂæÑÔºàÈÄöÂ∏∏‰∏éÈÖçÁΩÆÊñá‰ª∂import„ÄÅgo.modÁöÑ modelÂêç‰∏ÄÊ†∑Ôºâ

```

> ‚úÖ Ê≥®ÊÑèËøôÈáåÊòØ `localPlugins`Ôºà‰∏çÊòØ `plugins`ÔºâÔºåTraefik v3 ËØÜÂà´ÁöÑÂÖ≥ÈîÆÂ≠óÊÆµ„ÄÇ



üìÑ `config/dynamic/routers.yml`ÔºàÂä®ÊÄÅÈÖçÁΩÆÔºâ

``` yaml
http:

  middlewares:
    tokenizer:                                              # Êèí‰ª∂ÁöÑÂà´ÂêçÔºåÊèê‰æõÁªôË∑ØÁî±ÂºïÁî®ÁöÑÂêçÁß∞
      plugin:
        llmtoken:                                           # Êèí‰ª∂ÁöÑÂà´ÂêçÂØπÂ∫îÁªëÂÆöÁöÑÂØπÂ∫îÊèí‰ª∂Âêç
          apiurl: "http://10.119.163.202:8000/api/report"   # Êî∂ÈõÜTokenÁöÑFastAPI WebÊúçÂä°Âô®

  routers:
    router-default:
      rule: "HeaderRegexp(`X-Model`, `^*$`)"
      service: service-default
      priority: 1

    router-qwen2:
      rule: "Header(`X-Model`, `qwen2.5-vl-instruct`)"
      service: service-qwen2
      middlewares:
        - tokenizer                                         # Êèí‰ª∂ÁöÑÂà´Âêç

  services:
    service-default:
      loadBalancer:
        servers:
          - url: http://10.119.163.202:9997
        passHostHeader: false

    service-qwen2:
      loadBalancer:
        servers:
          - url: http://10.119.163.202:9997
        passHostHeader: false
```





------

### üß™ Âõõ„ÄÅÂêØÂä®Âπ∂È™åËØÅÊèí‰ª∂

```bash
docker-compose down

docker-compose up --build
```

ËßÇÂØü Traefik Êó•ÂøóÔºåÁ°Æ‰øùÁúãÂà∞Ôºö

```
Plugin token loaded
```

ÊàñÊü•Áúã `http://localhost:8080/dashboard/` ÁúãÊèí‰ª∂ÊòØÂê¶ÂêØÁî®„ÄÇ

------

### üß† Ê∏©È¶®ÊèêÈÜí

| Ë¶ÅÁÇπ               | ÂÜÖÂÆπ                                      |
| ------------------ | ----------------------------------------- |
| Êèí‰ª∂ÁõÆÂΩï           | ‰∏ÄÂÆöË¶ÅÊú¨Âú∞Êúâ ` plugins-local/src`         |
| `go.mod` Ê®°ÂùóÂêç    | Ë¶Å‰∏é `traefik.yml` ‰∏≠ÁöÑ `moduleName` ‰∏ÄËá¥ |
| ‰∏çÈúÄË¶ÅËá™Â∑±ÊûÑÂª∫Êèí‰ª∂ | Traefik ‰ºöËá™Âä®Âú®ÂêØÂä®Êó∂ÊûÑÂª∫                |

------



## 







------

# üîß 3. FastAPI ÊúçÂä°Á´ØÂºÄÂèëÔºàToken ÂàÜÊûê & SQLite Â≠òÂÇ®Ôºâ

---



### üìÅ È°πÁõÆÁªìÊûÑ `fastapi-token-tracker/`

```
fastapi-token-tracker/
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ models.py
‚îú‚îÄ‚îÄ database.py
‚îú‚îÄ‚îÄ token_utils.py
‚îú‚îÄ‚îÄ requirements.txt
```

------

### üìÑ `requirements.txt`

```
fastapi
uvicorn
sqlalchemy
tiktoken
```

------

### üìÑ `database.py`

```python
from sqlalchemy import create_engine, Column, Integer, Float, Text, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "sqlite:///./token_stats.db"

engine = create_engine(DATABASE_URL, connect_args={"check_same_thread": False})
SessionLocal = sessionmaker(bind=engine)
Base = declarative_base()

class TokenStat(Base):
    __tablename__ = "token_stats"

    id = Column(Integer, primary_key=True, index=True)
    input_tokens = Column(Integer)
    output_tokens = Column(Integer)
    total_tokens = Column(Integer)
    elapsed_time = Column(Float)
    tokens_per_second = Column(Float)
    timestamp = Column(String)
    path = Column(String)
    model = Column(String)
    ip_address = Column(String)
    request_body = Column(Text)
    response_body = Column(Text)

Base.metadata.create_all(bind=engine)
```

------

### üìÑ `token_utils.py`

```python
import json
import tiktoken

def count_tokens_from_messages(messages, model="gpt-3.5-turbo"):
    try:
        encoding = tiktoken.encoding_for_model(model)
    except:
        encoding = tiktoken.get_encoding("cl100k_base")

    num_tokens = 0
    for msg in messages:
        num_tokens += 4
        for key, val in msg.items():
            num_tokens += len(encoding.encode(val))
    num_tokens += 2
    return num_tokens

def count_output_tokens(text: str, model="gpt-3.5-turbo"):
    try:
        encoding = tiktoken.encoding_for_model(model)
    except:
        encoding = tiktoken.get_encoding("cl100k_base")
    return len(encoding.encode(text))
```

------

### üìÑ `main.py`

```python
from fastapi import FastAPI, Request, Depends
from sqlalchemy.orm import Session
from database import SessionLocal, TokenStat
from token_utils import count_tokens_from_messages, count_output_tokens
import json
from fastapi.responses import PlainTextResponse
from sqlalchemy import func


app = FastAPI()

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.post("/api/report")
async def track(request: Request, db: Session = Depends(get_db)):
    data = await request.json()

    request_body = data["request_body"]
    response_body = data["response_body"]
    elapsed_time = data["elapsed_time"]
    timestamp = data.get("timestamp")
    path = data.get("path")
    model = data.get("model")
    client_host = request.client.host

    # Â∞ùËØï‰ªéËØ∑Ê±Ç‰∏≠ÊèêÂèñ messages
    input_tokens = 0
    try:
        request_data = json.loads(request_body)
        messages = request_data.get("messages", [])
        input_tokens = count_tokens_from_messages(messages)
    except Exception:
        messages = []

    # Â∞ùËØï‰ªéÂìçÂ∫î‰∏≠ÊèêÂèñ content
    output_tokens = 0
    try:
        response_data = json.loads(response_body)
        content = response_data["choices"][0]["message"]["content"]
        output_tokens = count_output_tokens(content)
    except Exception:
        content = ""

    total_tokens = input_tokens + output_tokens
    tps = total_tokens / elapsed_time if elapsed_time > 0 else 0

    record = TokenStat(
        input_tokens=input_tokens,
        output_tokens=output_tokens,
        total_tokens=total_tokens,
        elapsed_time=elapsed_time,
        tokens_per_second=tps,
        timestamp=timestamp,
        path=path,
        model=model,
        ip_address=client_host,
        request_body=request_body,
        response_body=response_body,
    )
    db.add(record)
    db.commit()

    return {"status": "ok", "total_tokens": total_tokens, "tps": tps}


@app.get("/api/metrics", response_class=PlainTextResponse)
def get_metrics(offset: int = 0, db: Session = Depends(get_db)):
    record = db.query(TokenStat).order_by(TokenStat.id.asc()).offset(offset).limit(1).first()
    if not record:
        return PlainTextResponse("# No record found", status_code=404)
    
    labels = f'model="{record.model}", path="{record.path}", ip="{record.ip_address}"'

    metrics = f"""
# HELP input_tokens Number of input tokens
# TYPE input_tokens gauge
input_tokens{{{labels}}} {record.input_tokens}

# HELP output_tokens Number of output tokens
# TYPE output_tokens gauge
output_tokens{{{labels}}} {record.output_tokens}

# HELP total_tokens Total number of tokens
# TYPE total_tokens gauge
total_tokens{{{labels}}} {record.total_tokens}

# HELP elapsed_time Request elapsed time in seconds
# TYPE elapsed_time gauge
elapsed_time{{{labels}}} {record.elapsed_time}

# HELP tokens_per_second Tokens processed per second
# TYPE tokens_per_second gauge
tokens_per_second{{{labels}}} {record.tokens_per_second}
""".strip()

    return metrics



# ÂêØÂä®
if __name__ == "__main__":
    import uvicorn

    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8000
    )

```

------

## ‚úÖ ÂêØÂä® FastAPI

```bash
python main.py
```

------
