---
title: "SeekDB æµ‹è¯•ä»£ç "
date: "2025-12-17"
categories: 
  - "databases"
---



# SeekDB æµ‹è¯•ä»£ç 



#### .env

``` ini
# é…ç½®è¿œç¨‹SeekDBæœåŠ¡åœ°å€
SEEKDB_HOST=*.*.*.*
SEEKDB_PORT=2881
SEEKDB_USER=root
SEEKDB_PASSWD=youpasswd
```



#### main.py

``` python
# -*- coding: utf-8 -*-
import os
from dotenv import load_dotenv
from sqlalchemy import create_engine, text
from sqlalchemy.orm import sessionmaker

load_dotenv()

# ===============================
# SeekDB è¿æ¥ä¿¡æ¯
# ===============================
HOST = os.getenv("SEEKDB_HOST")
PORT = os.getenv("SEEKDB_PORT")
USER = os.getenv("SEEKDB_USER")
PASSWORD = os.getenv("SEEKDB_PASSWD")
DATABASE = "seekdb"

DATABASE_URL = (
    f"mysql+pymysql://{USER}:{PASSWORD}@{HOST}:{PORT}/{DATABASE}?charset=utf8mb4"
)

engine = create_engine(
    DATABASE_URL,
    echo=False,
    future=True,
)

Session = sessionmaker(bind=engine, autoflush=False, autocommit=False)
session = Session()


# -------------------------------------------------
# 1ï¸âƒ£ å»ºè¡¨ï¼ˆå• FULLTEXT + å‘é‡ï¼‰
# -------------------------------------------------
def create_table():
    session.execute(text("DROP TABLE IF EXISTS t2"))

    sql = """
    CREATE TABLE t2 (
        id INT PRIMARY KEY,
        lang VARCHAR(4),
        doc VARCHAR(200),
        fulltext_doc TEXT,
        embedding VECTOR(3),

        FULLTEXT INDEX idx_ft_all (fulltext_doc)
            WITH PARSER ngram
            PARSER_PROPERTIES = (ngram_token_size = 2),

        VECTOR INDEX idx_vec_embedding (embedding)
            WITH (distance = L2, type = HNSW)
    );
    """
    session.execute(text(sql))
    session.commit()
    print("âœ… è¡¨ t2 åˆ›å»ºå®Œæˆï¼ˆå• FULLTEXT + VECTORï¼‰")


# -------------------------------------------------
# 2ï¸âƒ£ æ’å…¥ç¤ºä¾‹æ•°æ®
# -------------------------------------------------
def insert_sample_data():
    data = [
        # ===== ä¸­æ–‡ zh =====
        (1, 'zh', 'è‹¹æœ', 'è‹¹æœæ˜¯ä¸€ç§å¸¸è§çš„æ°´æœã€‚', '[1.0,1.0,1.0]'),
        (2, 'zh', 'é¦™è•‰', 'é¦™è•‰æ˜¯ä¸€ç§çƒ­å¸¦æ°´æœã€‚', '[1.1,1.0,0.9]'),
        (3, 'zh', 'è¥¿ç“œ', 'è¥¿ç“œæ˜¯å¤å­£æ°´æœã€‚', '[2.0,2.0,2.0]'),
        (4, 'zh', 'å’–å•¡', 'å’–å•¡æ˜¯ä¸€ç§æç¥é¥®å“ã€‚', '[0.5,0.6,0.4]'),
        (5, 'zh', 'æ‰‹æœº', 'æ™ºèƒ½æ‰‹æœºå·²ç»æ™®åŠã€‚', '[3.0,3.0,3.0]'),
        (6, 'zh', 'è€³æœº', 'æ— çº¿è€³æœºå¾ˆæµè¡Œã€‚', '[2.9,3.1,3.0]'),
        (7, 'zh', 'æ‰‹è¡¨', 'æ™ºèƒ½æ‰‹è¡¨æ”¯æŒå¥åº·ç›‘æµ‹ã€‚', '[1.5,1.4,1.6]'),
        (8, 'zh', 'æ±½è½¦', 'ç”µåŠ¨æ±½è½¦å‘å±•è¿…é€Ÿã€‚', '[5.0,5.1,4.9]'),
        (9, 'zh', 'å†°ç®±', 'å†°ç®±æ˜¯å®¶åº­ç”µå™¨ã€‚', '[4.0,4.1,3.9]'),
        (10, 'zh', 'æ¸¸æˆæœº', 'æ¸¸æˆæœºå¾ˆå—æ¬¢è¿ã€‚', '[3.5,3.4,3.6]'),

        # ===== æ—¥æ–‡ ja =====
        (101, 'ja', 'ã‚Šã‚“ã”', 'ã‚Šã‚“ã”ã¯äººæ°—ã®æœç‰©ã§ã™ã€‚', '[1.0,1.0,1.1]'),
        (102, 'ja', 'ãƒãƒŠãƒŠ', 'ãƒãƒŠãƒŠã¯æœç‰©ã§ã™ã€‚', '[1.1,1.0,0.9]'),
        (103, 'ja', 'ã‚¹ã‚¤ã‚«', 'ã‚¹ã‚¤ã‚«ã¯å¤ã®æœç‰©ã€‚', '[2.0,2.0,2.1]'),
        (104, 'ja', 'ã‚³ãƒ¼ãƒ’ãƒ¼', 'ã‚³ãƒ¼ãƒ’ãƒ¼ã¯é£²ã¿ç‰©ã§ã™ã€‚', '[0.5,0.6,0.4]'),
        (105, 'ja', 'ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³', 'ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã¯å¿…éœ€å“ã€‚', '[3.0,3.0,3.1]'),
        (106, 'ja', 'ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³', 'ãƒã‚¤ã‚ºã‚­ãƒ£ãƒ³ã‚»ãƒªãƒ³ã‚°æ­è¼‰ã€‚', '[2.9,3.1,3.0]'),
        (107, 'ja', 'ã‚¹ãƒãƒ¼ãƒˆã‚¦ã‚©ãƒƒãƒ', 'å¥åº·ç®¡ç†ã«å½¹ç«‹ã¤ã€‚', '[1.5,1.6,1.4]'),
        (108, 'ja', 'é›»æ°—è‡ªå‹•è»Š', 'EVãŒæ™®åŠã—ã¦ã„ã‚‹ã€‚', '[5.0,5.1,4.9]'),
        (109, 'ja', 'å†·è”µåº«', 'å®¶åº­ç”¨å†·è”µåº«ã€‚', '[4.0,4.1,3.9]'),
        (110, 'ja', 'ã‚²ãƒ¼ãƒ æ©Ÿ', 'ã‚²ãƒ¼ãƒ æ©Ÿã¯äººæ°—ã€‚', '[3.5,3.4,3.6]'),

        # ===== è‹±æ–‡ en =====
        (201, 'en', 'Apple', 'Apple is a fruit.', '[1.0,1.0,1.0]'),
        (202, 'en', 'Banana', 'Bananas are fruits.', '[1.1,1.0,0.9]'),
        (203, 'en', 'Watermelon', 'Watermelon is popular.', '[2.0,2.0,2.0]'),
        (204, 'en', 'Coffee', 'Coffee is a beverage.', '[0.5,0.6,0.4]'),
        (205, 'en', 'Smartphone', 'Smartphones are essential.', '[3.0,3.0,3.0]'),
        (206, 'en', 'Headphones', 'Wireless headphones.', '[2.9,3.1,3.0]'),
        (207, 'en', 'Smartwatch', 'Tracks health data.', '[1.5,1.4,1.6]'),
        (208, 'en', 'Electric Car', 'Electric cars are popular.', '[5.0,5.1,4.9]'),
        (209, 'en', 'Refrigerator', 'Home appliance.', '[4.0,4.1,3.9]'),
        (210, 'en', 'Game Console', 'Popular worldwide.', '[3.5,3.4,3.6]'),

        # ===== æ··åˆ mix =====
        (301, 'mix', 'Apple iPhone', 'Apple iPhone æ˜¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã€‚', '[1.1,1.1,1.1]'),
        (302, 'mix', 'Apple Watch', 'Apple Watch æ˜¯ smartwatchã€‚', '[0.9,1.0,0.8]'),
        (303, 'mix', 'å’–å•¡ Coffee ã‚³ãƒ¼ãƒ’ãƒ¼', 'å’–å•¡ Coffee ã‚³ãƒ¼ãƒ’ãƒ¼ æ˜¯é¥®å“ã€‚', '[0.5,0.6,0.4]'),
        (304, 'mix', 'Tesla Model 3', 'Tesla æ˜¯ electric carã€‚', '[5.0,5.1,4.9]'),
        (305, 'mix', 'Nintendo Switch', 'æ¸¸æˆæœº game consoleã€‚', '[3.0,3.1,2.9]')
    ]

    sql = """
    INSERT INTO t2 (id, lang, doc, fulltext_doc, embedding)
    VALUES (:id, :lang, :doc, :fulltext_doc, :embedding)
    ON DUPLICATE KEY UPDATE
        lang = VALUES(lang),
        doc = VALUES(doc),
        fulltext_doc = VALUES(fulltext_doc),
        embedding = VALUES(embedding)
    """

    params = [
        {
            "id": d[0],
            "lang": d[1],
            "doc": d[2],
            "fulltext_doc": d[3],
            "embedding": d[4],
        }
        for d in data
    ]

    session.execute(text(sql), params)
    session.commit()
    print(f"âœ… Upsert æ•°æ® {len(data)} æ¡")



# -------------------------------------------------
# 3ï¸âƒ£ å…¨æ–‡æ£€ç´¢
# -------------------------------------------------
def query_ft(keyword, prefer_lang=None):
    print(f"\nğŸ” FULLTEXT æŸ¥è¯¢: {keyword}")

    sql = """
    SELECT id, lang, doc,
           MATCH(fulltext_doc) AGAINST(:kw) AS score
    FROM t2
    WHERE MATCH(fulltext_doc) AGAINST(:kw)
    """

    params = {"kw": keyword}

    if prefer_lang:
        sql += " ORDER BY (lang = :lang) DESC, score DESC"
        params["lang"] = prefer_lang
    else:
        sql += " ORDER BY score DESC"

    result = session.execute(text(sql), params)
    for row in result.fetchall():
        print(row)


# -------------------------------------------------
# 4ï¸âƒ£ å‘é‡æ£€ç´¢
# -------------------------------------------------
def query_vector(vec, limit=5):
    print(f"\nğŸ” å‘é‡æ£€ç´¢ TOP {limit}")

    sql = f"""
    SELECT id, lang, doc
    FROM t2
    ORDER BY l2_distance(embedding, :vec)
    LIMIT {limit}
    """

    result = session.execute(text(sql), {"vec": vec})
    for row in result.fetchall():
        print(row)


# -------------------------------------------------
# 5ï¸âƒ£ ä¸»æµç¨‹
# -------------------------------------------------
if __name__ == "__main__":
    create_table()
    insert_sample_data()

    query_ft("ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³", prefer_lang="ja")
    query_ft("smartwatch", prefer_lang="en")
    query_ft("ã‚³ãƒ¼ãƒ’ãƒ¼")
    query_ft("fruit")
    query_ft("æ°´æœ")

    query_vector("[0.9,1.0,0.9]")

    session.close()
    engine.dispose()
    print("\nâœ… å®Œæˆ")

```

