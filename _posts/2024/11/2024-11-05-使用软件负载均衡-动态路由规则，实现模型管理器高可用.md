# ä½¿ç”¨è½¯ä»¶è´Ÿè½½å‡è¡¡-åŠ¨æ€è·¯ç”±è§„åˆ™ï¼Œå®ç°æ¨¡å‹ç®¡ç†å™¨é«˜å¯ç”¨



## å¿«é—®å¿«ç­”

>é—®ï¼š
>
>æˆ‘æœ‰ä¸¤å°è™šæ‹Ÿæœºï¼Œvm01 å’Œ vm02,  æˆ‘åœ¨vm01ä¸Šå¯åŠ¨äº†ä¸€ä¸ªxinference,å…¶ä¸­å¯åŠ¨äº†ä¸¤ä¸ªNLPæ¨¡å‹ï¼Œglm4-9b å’Œ qwen2.5-1.5B æˆ‘åœ¨vm02ä¸Šä¹Ÿå¯åŠ¨äº†ä¸€ä¸ªxinference,å…¶ä¸­å¯åŠ¨äº†ä¸€ä¸ªNLPæ¨¡å‹ï¼Œglm4-9b æˆ‘å¸Œæœ›å½“æˆ‘è¯·æ±‚glm4-9bæ¨¡å‹çš„æ—¶å€™ä»–å¯ä»¥è‡ªåŠ¨è´Ÿè½½ï¼Œvm01 å’Œ vm02, ä½†å½“æˆ‘è¯·æ±‚çš„æ˜¯qwen2.5-1.5Bæ¨¡å‹çš„æ—¶å€™ï¼Œå°±åªè¯·æ±‚vm01 åœ¨è¿™ä¸ªåœºæ™¯ä¸­ envoy èƒ½åšåˆ°å—ï¼Ÿå…¶å®ƒçš„è¿˜æœ‰å“ªäº›èƒ½åšåˆ°ï¼Ÿ
>
>
>
>ç­”ï¼š
>
>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼ŒEnvoy å¯ä»¥å®Œå…¨æ»¡è¶³ä½ çš„éœ€æ±‚ã€‚ä½ å¯ä»¥é…ç½® Envoyï¼Œä½¿å…¶æ ¹æ®è¯·æ±‚çš„æ¨¡å‹åç§°è¿›è¡ŒåŠ¨æ€è·¯ç”±ï¼š
>
>1. **è¯·æ±‚ glm4-9b**ï¼šEnvoy ä¼šå°†è¯·æ±‚å‡åŒ€åˆ†å‘åˆ° vm01 å’Œ vm02 ä¸Šçš„ glm4-9b æ¨¡å‹ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚
>2. **è¯·æ±‚ qwen2.5-1.5B**ï¼šEnvoy ä¼šå°†è¯·æ±‚ç›´æ¥è·¯ç”±åˆ° vm01 çš„ qwen2.5-1.5B æ¨¡å‹ã€‚
>
>è¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œä½ éœ€è¦é…ç½® Envoy çš„è·¯ç”±è§„åˆ™å’Œè´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚
>
>å…¶ä»–å¯ä»¥å®ç°ç±»ä¼¼åŠŸèƒ½çš„è§£å†³æ–¹æ¡ˆåŒ…æ‹¬ï¼š
>
>1. **Nginx**ï¼šé€šè¿‡ä½¿ç”¨ `location` æŒ‡ä»¤å’Œè´Ÿè½½å‡è¡¡æ¨¡å—ï¼Œå¯ä»¥å®ç°ç›¸ä¼¼çš„åŠ¨æ€è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ã€‚
>2. **Traefik**ï¼šåŒæ ·æ”¯æŒæ ¹æ®è¯·æ±‚çš„ç‰¹å¾è¿›è¡ŒåŠ¨æ€è·¯ç”±ï¼Œå¯ä»¥è®¾ç½®ä¸åŒçš„æœåŠ¡å’Œè·¯ç”±è§„åˆ™ã€‚
>3. **HAProxy**ï¼šå¯ä»¥ä½¿ç”¨ ACLsï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰æ¥æ ¹æ®è¯·æ±‚çš„æ¡ä»¶è¿›è¡Œè·¯ç”±å’Œè´Ÿè½½å‡è¡¡ã€‚
>
>è¿™äº›å·¥å…·éƒ½èƒ½å¤Ÿæ ¹æ®ä½ çš„éœ€æ±‚è¿›è¡Œçµæ´»é…ç½®ã€‚

>é—®ï¼š
>
>Envoyã€Nginxã€HAProxyã€Traefikå“ªä¸ªæ›´å®¹æ˜“é…ç½®å’Œç®¡ç†ï¼Ÿ
>
>
>
>ç­”ï¼š
>
>é…ç½®å’Œç®¡ç†çš„éš¾æ˜“ç¨‹åº¦å› äººè€Œå¼‚ï¼Œä½†ä¸€èˆ¬æ¥è¯´ï¼š
>
>1. **Traefik**ï¼šä»¥ç®€å•æ˜“ç”¨è‘—ç§°ï¼Œå°¤å…¶é€‚åˆå®¹å™¨åŒ–ç¯å¢ƒå’Œå¾®æœåŠ¡æ¶æ„ã€‚è‡ªåŠ¨å‘ç°æœåŠ¡å’ŒåŠ¨æ€é…ç½®éå¸¸æ–¹ä¾¿ï¼Œé€‚åˆå¿«é€Ÿä¸Šæ‰‹ã€‚
>
>2. **Nginx**ï¼šé…ç½®çµæ´»ä¸”åŠŸèƒ½å¼ºå¤§ï¼Œä½†éœ€è¦æ‰‹åŠ¨é…ç½®å’Œé‡è½½ï¼Œåˆå­¦è€…å¯èƒ½ä¼šè§‰å¾—å¤æ‚ã€‚
>
>3. **HAProxy**ï¼šé«˜æ€§èƒ½ä¸”é…ç½®é€‰é¡¹ä¸°å¯Œï¼Œé€‚åˆæœ‰é«˜å¹¶å‘éœ€æ±‚çš„åœºæ™¯ï¼Œä½†å…¶é…ç½®è¯­æ³•è¾ƒä¸ºå¤æ‚ã€‚
>
>4. **Envoy**ï¼šåŠŸèƒ½å¼ºå¤§ä¸”é€‚åˆå¾®æœåŠ¡æ¶æ„ï¼Œä½†åˆå§‹é…ç½®å¯èƒ½ç›¸å¯¹å¤æ‚ï¼Œç‰¹åˆ«æ˜¯åœ¨è®¾ç½®é«˜çº§è·¯ç”±å’Œè´Ÿè½½å‡è¡¡æ—¶ã€‚
>
>æ€»ä½“è€Œè¨€ï¼Œå¦‚æœä½ éœ€è¦å¿«é€Ÿä¸Šæ‰‹å¹¶ä¸”åœ¨å®¹å™¨åŒ–ç¯å¢ƒä¸­ä½¿ç”¨ï¼ŒTraefik æ˜¯ä¸é”™çš„é€‰æ‹©ï¼›å¦‚æœéœ€è¦é«˜åº¦è‡ªå®šä¹‰ï¼ŒNginx å’Œ HAProxy å¯èƒ½æ›´åˆé€‚ã€‚Envoy åˆ™é€‚åˆå¯¹æµé‡ç®¡ç†æœ‰è¾ƒé«˜éœ€æ±‚çš„å¤æ‚åœºæ™¯ã€‚
>
>
>
>ä»¥ä¸‹æ˜¯å°†å„ä¸ªè´Ÿè½½å‡è¡¡å’Œä»£ç†å·¥å…·æ•´ç†æˆå¯¹æ¯”è¡¨æ ¼çš„ç»“æœï¼š
>
>| å·¥å…·        | é€‚ç”¨åœºæ™¯                               | ä¼˜åŠ¿                                                         |
>| ----------- | -------------------------------------- | ------------------------------------------------------------ |
>| **Traefik** | å¾®æœåŠ¡æ¶æ„ã€å®¹å™¨åŒ–ç¯å¢ƒ                 | - è‡ªåŠ¨æœåŠ¡å‘ç°<br>- æ˜“äºé›†æˆ<br>- ç®€å•çš„é…ç½®<br>- å†…ç½®ä¸­é—´ä»¶ |
>| **Nginx**   | é™æ€å†…å®¹æœåŠ¡ã€åå‘ä»£ç†ã€Web åº”ç”¨       | - é«˜æ€§èƒ½<br>- çµæ´»æ€§<br>- SSL/TLSæ”¯æŒ<br>- å¤§é‡ç¤¾åŒºæ”¯æŒ      |
>| **HAProxy** | é«˜å¹¶å‘åœºæ™¯ã€é‡‘èæœåŠ¡ã€é«˜å¯ç”¨åº”ç”¨       | - é«˜æ€§èƒ½<br>- ç²¾ç¡®çš„è´Ÿè½½å‡è¡¡ç­–ç•¥<br>- è¯¦ç»†çš„ç›‘æ§å’Œç»Ÿè®¡<br>- é€‚åº”æ€§å¼º |
>| **Envoy**   | å¾®æœåŠ¡æ¶æ„ã€æœåŠ¡ç½‘æ ¼ã€å¤æ‚æµé‡ç®¡ç†éœ€æ±‚ | - ä¸°å¯Œçš„åŠŸèƒ½<br>- é«˜åº¦å¯æ‰©å±•<br>- å¼ºå¤§çš„è§‚å¯Ÿæ€§<br>- é€‚åˆå¤æ‚ç¯å¢ƒ |
>
>è¿™ä¸ªè¡¨æ ¼æ€»ç»“äº†æ¯ä¸ªå·¥å…·çš„é€‚ç”¨åœºæ™¯å’Œä¸»è¦ä¼˜åŠ¿ï¼Œä¾¿äºå¯¹æ¯”å’Œé€‰æ‹©ã€‚

>é—®ï¼š
>
>è¦åœ¨è™šæ‹Ÿæœºä¸Šéƒ¨ç½²ä½¿ç”¨çš„ï¼Œè¿˜éœ€è¦é…ç½®åŠ¨æ€è·¯ç”±å“ªä¸ªæœ€åˆé€‚
>
>
>
>ç­”ï¼š
>
>åœ¨è™šæ‹Ÿæœºä¸Šéƒ¨ç½²ä½¿ç”¨å¹¶éœ€è¦é…ç½®åŠ¨æ€è·¯ç”±çš„æƒ…å†µä¸‹ï¼Œ**Traefik** å’Œ **Envoy** æ˜¯ä¸¤ä¸ªéå¸¸åˆé€‚çš„é€‰æ‹©ï¼š
>
>1. **Traefik**ï¼š
>
>  - **ä¼˜åŠ¿**ï¼š
>    - é…ç½®ç®€å•ï¼Œæ˜“äºä¸Šæ‰‹ï¼Œç‰¹åˆ«é€‚åˆå¿«é€Ÿéƒ¨ç½²ã€‚
>    - æ”¯æŒåŠ¨æ€è·¯ç”±ï¼Œèƒ½å¤Ÿæ ¹æ®è¯·æ±‚ç‰¹å¾ï¼ˆå¦‚ URLï¼‰è‡ªåŠ¨è·¯ç”±åˆ°ä¸åŒçš„æœåŠ¡ã€‚
>    - è‡ªå¸¦ä¸­é—´ä»¶åŠŸèƒ½ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å¤„ç†èº«ä»½éªŒè¯ã€é€Ÿç‡é™åˆ¶ç­‰ã€‚
>
>2. **Envoy**ï¼š
>
>  - **ä¼˜åŠ¿**ï¼š
>    - åŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå¤æ‚çš„æµé‡ç®¡ç†å’ŒåŠ¨æ€è·¯ç”±ã€‚
>    - æä¾›ä¸°å¯Œçš„ observabilityï¼ˆå¯è§‚å¯Ÿæ€§ï¼‰ç‰¹æ€§ï¼Œä¾¿äºç›‘æ§å’Œè°ƒè¯•ã€‚
>    - é«˜åº¦å¯æ‰©å±•ï¼Œé€‚åˆéœ€è¦ç²¾ç»†æµé‡æ§åˆ¶çš„åœºæ™¯ã€‚
>
>å¦‚æœä½ å¸Œæœ›å¿«é€Ÿéƒ¨ç½²å¹¶ä¸”é…ç½®ç›¸å¯¹ç®€å•ï¼Œ**Traefik** å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚å¦‚æœä½ éœ€è¦æ›´å¼ºå¤§çš„åŠŸèƒ½å’Œçµæ´»æ€§ï¼Œå°¤å…¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œ**Envoy** åˆ™æ›´ä¸ºåˆé€‚ã€‚



## ä»€ä¹ˆæ˜¯Traefik

>Traefik æ˜¯ä¸€æ¬¾ç°ä»£åŒ–çš„åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å™¨ï¼Œå®ƒåœ¨ä»Šå¤©çš„äº‘åŸç”Ÿç”Ÿæ€ç³»ç»Ÿä¸­æ‰®æ¼”ç€éå¸¸é‡è¦çš„è§’è‰²ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥äº†è§£Traefikæ˜¯ä»€ä¹ˆï¼Œå®ƒçš„åŠŸèƒ½ä»¥åŠå¦‚ä½•åœ¨ç°ä»£æ¶æ„ä¸­æä¾›ä»·å€¼ã€‚
>
>1. ä»€ä¹ˆæ˜¯Traefikï¼Ÿ ğŸ¤”
>     Traefikï¼ˆå‘éŸ³ä¸º"traffic"ï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨ã€‚å®ƒä¸ºå¾®æœåŠ¡æ¶æ„æä¾›äº†ç½‘ç»œå…¥å£ï¼Œç‰¹åˆ«æ˜¯åœ¨åŠ¨æ€ã€æœåŠ¡å¯†é›†çš„ç¯å¢ƒä¸­ï¼ˆå¦‚å®¹å™¨ã€å¾®æœåŠ¡æ¶æ„ï¼‰ã€‚ç”±äºå…¶è®¾è®¡çµæ´»ä¸”æ˜“äºå®æ–½ï¼ŒTraefik æˆä¸ºäº†DevOpså·¥ç¨‹å¸ˆå’Œäº‘åŸç”Ÿåº”ç”¨å¼€å‘è€…çš„çƒ­é—¨é€‰æ‹©ğŸ”¥ã€‚
>
>2. Traefikæœ‰ä»€ä¹ˆç”¨ï¼Ÿ ğŸ› ï¸
> 3. è‡ªåŠ¨åŒ–çš„æœåŠ¡å‘ç°ï¼š Traefik å¯ä»¥è‡ªåŠ¨å‘ç°å¹¶ç®¡ç†ç½‘ç»œè·¯ç”±é…ç½®ã€‚æ— è®ºæ˜¯åœ¨Kubernetesã€Dockerè¿˜æ˜¯å…¶ä»–ä»»ä½•â€œæœåŠ¡å‘ç°â€å…¼å®¹çš„ç¯å¢ƒä¸­ï¼Œå½“ä½ éƒ¨ç½²æ–°æœåŠ¡æ—¶ï¼ŒTraefik ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶é…ç½®è·¯ç”±ï¼Œæ— éœ€ä»»ä½•äººå·¥å¹²é¢„ğŸ‘€ã€‚
>
> 4. æ— ç¼çš„è´Ÿè½½å‡è¡¡ï¼š Traefik æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ŒåŒ…æ‹¬è½®è¯¢ã€IPå“ˆå¸Œç­‰ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ç”¨æˆ·è¯·æ±‚è¢«å¹³å‡ä¸”æœ‰æ•ˆåœ°åˆ†é…åˆ°åç«¯æœåŠ¡ä¸Šï¼Œä¼˜åŒ–èµ„æºåˆ©ç”¨å¹¶æé«˜å“åº”é€Ÿåº¦ğŸ’¨ã€‚
>
> 5. è‡ªåŠ¨HTTPSï¼š åˆ©ç”¨Letâ€™s Encryptï¼ŒTraefik å¯ä»¥è‡ªåŠ¨ä¸ºä½ çš„æœåŠ¡ç”Ÿæˆå’Œç»­è®¢SSLè¯ä¹¦ï¼Œä¿è¯æ•°æ®ä¼ è¾“çš„å®‰å…¨ğŸ”’ã€‚
>
> 6. å¯è§‚æµ‹æ€§å’Œç›‘æ§ï¼š Traefik æä¾›å®æ—¶çš„ç›‘æ§å’Œåº¦é‡ï¼Œæ”¯æŒä¸Prometheus, Grafanaç­‰å·¥å…·é›†æˆã€‚è¿™è®©å¼€å‘è€…å’Œè¿ç»´å›¢é˜Ÿèƒ½å¤Ÿå®æ—¶ç›‘æ§åº”ç”¨çš„çŠ¶æ€å’Œæ€§èƒ½ğŸ“Šã€‚
>
> 7. ä¸­é—´ä»¶æ”¯æŒï¼š Traefik å…è®¸å¼€å‘è€…ä½¿ç”¨ä¸­é—´ä»¶æ¥ä¿®æ”¹è¯·æ±‚å’Œå“åº”ï¼Œå®ç°è¯¸å¦‚é™æµã€è®¤è¯ã€è¯·æ±‚å¤´ä¿®æ”¹ç­‰é«˜çº§åŠŸèƒ½ğŸ”§ã€‚
>
>
>3. ä¸ºä»€ä¹ˆé€‰æ‹©Traefikï¼Ÿ ğŸŒŸ
>     æ˜“äºé…ç½®ä¸ç»´æŠ¤ï¼š Traefik çš„é…ç½®ç®€å•ç›´è§‚ï¼Œæ”¯æŒåŠ¨æ€é…ç½®æ›´æ–°ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨ä¸åœæ­¢æœåŠ¡çš„æƒ…å†µä¸‹æ›´æ–°å’Œåº”ç”¨æ–°çš„é…ç½®ğŸ”„ã€‚
>     é«˜æ€§èƒ½ï¼š Traefik è¢«è®¾è®¡ä¸ºé«˜æ€§èƒ½çš„ä»£ç†ï¼Œèƒ½å¤Ÿå¤„ç†å¤§é‡çš„å¹¶å‘è¿æ¥å’Œè¯·æ±‚ï¼Œéå¸¸é€‚åˆç°ä»£é«˜æµé‡çš„åº”ç”¨ç¯å¢ƒğŸš€ã€‚
>     äº‘åŸç”Ÿå‹å¥½ï¼š å®ƒæ˜¯ä¸ºäº‘åŸç”Ÿåº”ç”¨è®¾è®¡çš„ï¼Œéå¸¸é€‚åˆç”¨åœ¨Kuberneteså’ŒDockerç­‰å®¹å™¨åŒ–ç¯å¢ƒä¸­ï¼Œå¯ä»¥è½»æ¾æ‰©å±•å’Œé€‚åº”å„ç§å¤æ‚åœºæ™¯ğŸŒã€‚
>4. æ€»ç»“ ğŸ“
>     Traefik æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œèƒ½å¤Ÿå¸®åŠ©ç°ä»£ä¼ä¸šè½»æ¾åœ°ç®¡ç†å¤æ‚çš„ç½‘ç»œå’ŒæœåŠ¡æ¶æ„ã€‚å®ƒä¸ä»…ç®€åŒ–äº†ç½‘ç»œé…ç½®çš„å¤æ‚æ€§ï¼Œè¿˜æä¾›äº†è‡ªåŠ¨åŒ–çš„å·¥å…·å’Œä¸°å¯Œçš„åŠŸèƒ½æ¥ä¼˜åŒ–å’Œä¿æŠ¤ä½ çš„åº”ç”¨ã€‚æ— è®ºä½ æ˜¯åœ¨å¯»æ‰¾ä¸€ä¸ªé«˜æ•ˆçš„è´Ÿè½½å‡è¡¡è§£å†³æ–¹æ¡ˆï¼Œè¿˜æ˜¯éœ€è¦ä¸€ä¸ªæ”¯æŒè‡ªåŠ¨HTTPSå’ŒæœåŠ¡å‘ç°çš„ç°ä»£åå‘ä»£ç†ï¼ŒTraefik éƒ½æ˜¯ä¸€ä¸ªå€¼å¾—è€ƒè™‘çš„é€‰æ‹©ã€‚é€šè¿‡ä½¿ç”¨ Traefikï¼Œä½ å¯ä»¥ç¡®ä¿ä½ çš„æœåŠ¡æ—¢å®‰å…¨åˆé«˜æ•ˆåœ°å¯¹å¤–æä¾›æœåŠ¡ğŸš€ã€‚
>
>
>
>[GitHub - traefik/traefikï¼šäº‘åŸç”Ÿåº”ç”¨ç¨‹åºä»£ç†](https://github.com/traefik/traefik)





---



# æµ‹è¯•ç¯å¢ƒ

```
                            traefik-server(VM01)
                                    |
                                    V
                  -------------------------------------
                 |                                     |
                 V                                     V
            GPU 01(VM02)                          GPU 02(VM03)
       [QWen2.5-0.5B-Instruct]                [QWen2.5-0.5B-Instruct]
                                              [glm4-9b-chat]
```



VM01 `10.200.19.2` å®‰è£…traefikè´Ÿè½½å‡è¡¡æœåŠ¡

VM02 `10.200.19.3` å®‰è£…æ¨¡å‹ç®¡ç†çš„WebæœåŠ¡ç«¯

VM03 `10.200.19.4` å®‰è£…æ¨¡å‹ç®¡ç†çš„WebæœåŠ¡ç«¯

### VM01-å®‰è£…éƒ¨ç½²`traefik`

``` shell
docker login --username=mao_siyu registry.cn-qingdao.aliyuncs.com

docker pull registry.cn-qingdao.aliyuncs.com/cn-aliyun/traefik:v3.2.0

docker tag registry.cn-qingdao.aliyuncs.com/cn-aliyun/traefik:v3.2.0 traefik:v3.2.0

```

#### docker-compose.yaml

``` bash
version: '3.6'

services:
  reverse-proxy:
    image: traefik:v3.2.0
    command:
      - --providers.docker  # å¯ç”¨ Docker ä½œä¸ºæœåŠ¡æä¾›è€…
    ports:
      - "80:80"       # Traefik ç›‘å¬ 80 ç«¯å£
      - "8080:8080"   # Traefik Web UI ç›‘å¬ 8080 ç«¯å£
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Traefik éœ€è¦è®¿é—® Docker socket
      - ./traefik.yaml:/etc/traefik/traefik.yml    # é€šè¿‡é…ç½®æ–‡ä»¶åŠ è½½ Traefik é…ç½®
#    extra_hosts:
#      - "service1.example.com:<VM02_IP>"  # å°† service1.example.com æ˜ å°„åˆ° VM02 çš„ IP åœ°å€ã€‚å¦‚ï¼š10.200.19.3
#      - "service2.example.com:<VM03_IP>"  # å°† service2.example.com æ˜ å°„åˆ° VM03 çš„ IP åœ°å€ã€‚å¦‚ï¼š10.200.19.4
#      - "service1.example.com:10.200.19.3"
#      - "service2.example.com:10.200.19.4"

```



### æµ‹è¯•-åŸºäº`ä¸»æœºå`çš„`å®šå‘è·¯ç”±`è§„åˆ™

#### traefik.yaml

``` yaml
# traefik.yaml
api:
  insecure: true  # å¯ç”¨ Web UIï¼Œä¾›å¼€å‘äººå‘˜ä½¿ç”¨

log:
  level: DEBUG     # å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡º

entryPoints:
  web:
    address: ":80"  # HTTP å…¥å£ç‚¹

providers:
  file:
    filename: /etc/traefik/traefik.yml  # åŠ è½½å¤–éƒ¨é…ç½®æ–‡ä»¶
    watch: true                         # å…è®¸Traefikè‡ªåŠ¨ç›‘è§†æ–‡ä»¶æ›´æ”¹

# Enable health check ping
ping:
  entryPoint: web

# Traefik é…ç½®éƒ¨åˆ†ï¼Œä½¿ç”¨ file provider åŠ è½½é™æ€è·¯ç”±
http:
  routers:
    router-vm02:
      rule: Host(`service1.example.com`)  # å¤–éƒ¨è¯·æ±‚çš„ä¸»æœºå
      service: service-vm02  # æŒ‡å‘ vm02 ä¸Šçš„æœåŠ¡

    router-vm03:
      rule: Host(`service2.example.com`)
      service: service-vm03

  services:
    service-vm02:
      loadBalancer:
        servers:
#          - url: http://<VM02_IP>:8080  # æŒ‡å‘ vm02 ä¸Šçš„æœåŠ¡ï¼ˆä½¿ç”¨ IP åœ°å€ï¼‰å¦‚ï¼š10.200.19.3
          - url: http://10.200.19.3:8080

    service-vm03:
      loadBalancer:
        servers:
#          - url: http://<VM03_IP>:8080  # æŒ‡å‘ vm03 ä¸Šçš„æœåŠ¡ï¼ˆä½¿ç”¨ IP åœ°å€ï¼‰å¦‚ï¼š10.200.19.4
          - url: http://10.200.19.4:8080

```



```bash
curl -X 'POST' \
  'http://10.200.19.2/v1/chat/completions' \
  -H 'Host: service1.example.com' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "model": "Qwen2.5-0.5B-Instruct",
    "stream": true,
    "messages": [
      {
        "role": "user",
        "content": "è®²ä¸ªå°çº¢å¸½çš„æ•…äº‹"
      }
    ]
}'

```

``` bash
curl -X 'POST' \
  'http://10.200.19.2/v1/chat/completions' \
  -H 'Host: service2.example.com' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "model": "Qwen2.5-0.5B-Instruct",
    "stream": true,
    "messages": [
      {
        "role": "user",
        "content": "è®²ä¸ªå¤§ç°ç‹¼çš„æ•…äº‹"
      }
    ]
}'
```

### æµ‹è¯•-åŸºäºè¯·æ±‚`æ¨¡å‹å`çš„`åŠ¨æ€è·¯ç”±`è§„åˆ™

#### traefik.yaml

``` yaml
api:
  insecure: true  # å¯ç”¨ Web UIï¼Œä¾›å¼€å‘äººå‘˜ä½¿ç”¨

log:
  level: DEBUG     # å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡º

entryPoints:
  web:
    address: ":80"  # HTTP å…¥å£ç‚¹

providers:
  file:
    filename: /etc/traefik/traefik.yml  # åŠ è½½å¤–éƒ¨é…ç½®æ–‡ä»¶
    watch: true                         # å…è®¸Traefikè‡ªåŠ¨ç›‘è§†æ–‡ä»¶æ›´æ”¹(æš‚æ—¶æµ‹è¯•ï¼Œä¸èµ·ä½œç”¨)

# Enable health check ping
ping:
  entryPoint: web

# Traefik é…ç½®éƒ¨åˆ†ï¼Œä½¿ç”¨ file provider åŠ è½½é™æ€è·¯ç”±
http:
  routers:
    router-qwen2:
      rule: "Host(`service.example.com`) && Header(`X-Model`, `Qwen2.5-0.5B-Instruct`)"  # åŒ¹é… X-Model ä¸º Qwen2.5-0.5B-Instruct
      service: service-qwen2  # æŒ‡å‘è½®è¯¢æœåŠ¡

    router-glm4:
      rule: "Host(`service.example.com`) && Header(`X-Model`, `glm4-9b-chat`)"  # åŒ¹é… X-Model ä¸º glm4-9b-chat
      service: service-glm4  # æŒ‡å‘ä»… vm03 æœåŠ¡

  services:
    # è½®è¯¢æœåŠ¡ï¼Œé€‚ç”¨äº Qwen2.5-0.5B-Instruct æ¨¡å‹
    service-qwen2:
      loadBalancer:
        servers:
          - url: http://10.200.19.3:8080  # æŒ‡å‘ vm02 ä¸Šçš„æœåŠ¡
          - url: http://10.200.19.4:8080  # æŒ‡å‘ vm03 ä¸Šçš„æœåŠ¡
        passHostHeader: false  # ä¸ä¼ é€’åŸå§‹è¯·æ±‚çš„ Host å¤´éƒ¨

    # ä»…è·¯ç”±åˆ° vm03ï¼Œé€‚ç”¨äº glm4-9b-chat æ¨¡å‹
    service-glm4:
      loadBalancer:
        servers:
          - url: http://10.200.19.4:8080  # åªæŒ‡å‘ vm03 ä¸Šçš„æœåŠ¡
        passHostHeader: false  # ä¸ä¼ é€’åŸå§‹è¯·æ±‚çš„ Host å¤´éƒ¨

```



``` bash
curl -X 'POST' \
  'http://10.200.19.2/v1/chat/completions' \
  -H 'Host: service.example.com' \
  -H 'X-Model: Qwen2.5-0.5B-Instruct' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "model": "Qwen2.5-0.5B-Instruct",
    "stream": true,
    "messages": [
      {
        "role": "user",
        "content": "è®²ä¸ªå°çº¢å¸½çš„æ•…äº‹"
      }
    ]
}'

```

``` bash
curl -X 'POST' \
  'http://10.200.19.2/v1/chat/completions' \
  -H 'Host: service.example.com' \
  -H 'X-Model: glm4-9b-chat' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "model": "glm4-9b-chat",
    "stream": true,
    "messages": [
      {
        "role": "user",
        "content": "è®²ä¸ªå°çº¢å¸½çš„æ•…äº‹"
      }
    ]
}'

```



## æ¼”ç¤ºæ•ˆæœ

![](images/LB_Model_Server.gif) 

![](images/traefik_01.png) 

![](images/traefik_02.png) 

![](images/traefik_03.png) 

![](images/traefik_04.png) 
