---
title: 'K8S 1.24.0 安装部署'
date: '2022-05-25T12:11:12+00:00'
status: publish
permalink: /2022/05/25/k8s-1-24-0-%e5%ae%89%e8%a3%85%e9%83%a8%e7%bd%b2
author: 毛巳煜
excerpt: ''
type: post
id: 8682
category:
    - Kubernetes
tag: []
post_format: []
hestia_layout_select:
    - sidebar-right
wb_sst_seo:
    - 'a:3:{i:0;s:0:"";i:1;s:0:"";i:2;s:0:"";}'
---
###### [最佳实践](https://kubernetes.io/zh/docs/setup/best-practices/ "最佳实践")

###### [支持](https://kubernetes.io/zh/docs/setup/best-practices/cluster-large/#%E6%94%AF%E6%8C%81 "支持")

在 v1.2x 版本中， Kubernetes 支持的最大节点数为 5000。更具体地说，我们支持满足以下所有条件的配置：

- 节点数不超过 `5000`
- 每个节点的 pod 数量不超过 `100`
- Pod 总数不超过 `150000`
- 容器总数不超过 `300000`

- - - - - -

- - - - - -

- - - - - -

###### **[官方文档](https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/ "官方文档")**

###### **[国内教程](https://kuboard.cn/install/install-k8s.html "国内教程")**

- - - - - -

###### **Container Runtime**

- Kubernetes v1.20 开始，默认移除 docker 的依赖，如果宿主机上安装了 docker 和 containerd，将优先使用 docker 作为容器运行引擎，如果宿主机上未安装 docker 只安装了 containerd，将使用 containerd 作为容器运行引擎；
- 本文使用 containerd 作为容器运行引擎；

###### **关于二进制安装**

- **kubeadm** 是 Kubernetes 官方支持的安装方式，**不是`二进制`** 。本文档采用 kubernetes.io 官方推荐的 **kubeadm** 工具安装 kubernetes 集群。

- - - - - -

- - - - - -

- - - - - -

###### **`系统环境`**

```ruby
[root@master01 ~]# cat /etc/redhat-release
CentOS Linux release 7.9.2009 (Core)
[root@master01 ~]#
[root@master01 ~]#
[root@master01 ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

10.22.12.61     master01
10.22.12.62     master02
10.22.12.63     master03
10.22.12.64     worker01
10.22.12.65     worker02
10.22.12.66     worker03
[root@master01 ~]#

```

- - - - - -

- - - - - -

- - - - - -

###### 卸载旧版本依赖

```ruby
# 卸载旧版本， 根据实际情况不用每次都卸载
yum remove -y containerd.io
# 卸载旧版本， 根据实际情况不用每次都卸载
yum remove -y kubelet kubeadm kubectl

```

###### **[重新安装k8s](http://www.dev-share.top/2019/12/11/%e9%87%8d%e6%96%b0%e5%ae%89%e8%a3%85-k8s/ "重新安装k8s")**

- - - - - -

##### **`安装 containerd`**

```ruby
# 在 master 节点和 worker 节点都要执行

# 指定k8s版本
export K8S_VERSION=1.24.0
# 指定Containerd版本
export CONTAINERD_VERSION=1.6.4

```

- - - - - -

> - 关于初始化时用到的环境变量  
>    **POD\_SUBNET** 所使用的网段不能与 **master节点/worker节点** 所在的网段重叠。该字段的取值为一个 **CIDR** 值，如果您对 **CIDR** 这个概念还不熟悉，请仍然执行 `export POD_SUBNET=10.100.0.1/16` 命令

###### 设置ApiServer的IP址

```ruby
# 单master节点时它为ApiServer的IP址，通常是master节点IP
# 高可用时它是负载均衡的虚IP(LOAD_BALANCER_IP)
export APISERVER_IP=10.22.12.61
# Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中
export POD_SUBNET=10.100.0.1/16

```

- - - - - -

###### **setup\_containerd.sh `在 master 节点和 worker 节点都要执行`**

```ruby
#!/bin/bash

# 在 master 节点和 worker 节点都要执行

if [[ <span class="katex math inline">{K8S_VERSION} == '' ]]
  then
    echo -e "\033[31m 缺少环境变量: export K8S_VERSION=</span>{K8S_VERSION} \033[0m"
    exit
  else
    echo -e "\033[32m export K8S_VERSION=<span class="katex math inline">{K8S_VERSION} \033[0m"
fi

if [[</span>{CONTAINERD_VERSION} == ''  ]]
  then
    echo -e "\033[31m 缺少环境变量: export CONTAINERD_VERSION=<span class="katex math inline">{CONTAINERD_VERSION} \033[0m"
    exit
  else
    echo -e "\033[32m export CONTAINERD_VERSION=</span>{CONTAINERD_VERSION} \033[0m"
fi

if [[ <span class="katex math inline">{APISERVER_IP} == '' ]]
  then
    echo -e "\033[31m 缺少环境变量: export APISERVER_IP=</span>{APISERVER_IP} \033[0m"
    exit
  else
    echo -e "\033[32m export APISERVER_IP=<span class="katex math inline">{APISERVER_IP} \033[0m"
fi

if [[</span>{POD_SUBNET} == ''  ]]
  then
    echo -e "\033[31m 缺少环境变量: export POD_SUBNET=<span class="katex math inline">{POD_SUBNET} \033[0m"
    exit
  else
    echo -e "\033[32m export POD_SUBNET=</span>{POD_SUBNET} \033[0m"
fi


# 安装 containerd
# 参考文档如下
# https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd

cat > /etc/modules-load.d/containerd.conf  /etc/sysctl.d/99-kubernetes-cri.conf  /etc/containerd/config.toml

# 修改Containerd配置文件，开启SystemdCgroup模式
sed -i "s/SystemdCgroup = false/SystemdCgroup = true/g" /etc/containerd/config.toml
# 根据实际版本
sed -i "s/pause:3.6/pause:3.7/g" /etc/containerd/config.toml


systemctl daemon-reload
systemctl enable containerd
systemctl restart containerd


# 关闭 防火墙
systemctl stop firewalld
systemctl disable firewalld

# 关闭 SeLinux
setenforce 0
sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config

# 关闭 swap
swapoff -a
yes | cp /etc/fstab /etc/fstab_bak
cat /etc/fstab_bak | grep -v swap > /etc/fstab

# 配置K8S的yum源
cat > /etc/yum.repos.d/kubernetes.repo  /etc/cni/net.d/10-containerd-net.conflist 
```

- - - - - -

- - - - - -

- - - - - -

##### **`初始化 master 节点`**

###### **init\_master.sh `只在 master 节点执行`**

```ruby
#!/bin/bash
# 只在第一个master节点上执行
# 脚本出错时终止执行
set -e

rm -rf ./kubeadm-config.yaml

cat > kubeadm-config.yaml 
```

- - - - - -

###### **安装网络插件, 只在 `master` 节点执行**

```ruby
wget http://qiniu.dev-share.top/cni/k8s-1.24.x-calico-3.20.5.yaml
kubectl apply -f k8s-1.24.x-calico-3.20.5.yaml


```

- - - - - -

- - - - - -

- - - - - -