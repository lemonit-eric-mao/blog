---
title: 将虚拟机中应用程序加入到联邦服务网格
date: '2021-09-03T10:38:02+00:00'
status: private
permalink: /2021/09/03/%e5%b0%86%e8%99%9a%e6%8b%9f%e6%9c%ba%e4%b8%ad%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e5%8a%a0%e5%85%a5%e5%88%b0%e8%81%94%e9%82%a6%e6%9c%8d%e5%8a%a1%e7%bd%91%e6%a0%bc
author: 毛巳煜
excerpt: ''
type: post
id: 7873
category:
    - Consul
tag: []
post_format: []
hestia_layout_select:
    - sidebar-right
---
###### 前置条件

**[Docker-Compose 基于虚拟机环境下 部署Consul联邦从集群](http://www.dev-share.top/2021/02/18/docker-compose-%e5%9f%ba%e4%ba%8e%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%8e%af%e5%a2%83%e4%b8%8b-%e9%83%a8%e7%bd%b2consul%e8%81%94%e9%82%a6%e4%bb%8e%e9%9b%86%e7%be%a4/ "Docker-Compose 基于虚拟机环境下 部署Consul联邦从集群")**

- - - - - -

##### 注意

**`注意`：一个主机必须要有一个 Client， 提供给当前主机的所有应用程序注册使用**  
**`注意`：应用程序必使用`Consul Client`执行注册命令才能进行注册**

- - - - - -

###### **`一`** 创建 **`static-server`** 应用程序的 docker-compose文件

```ruby
cat > docker-compose.yaml 
```

- - - - - -

###### **`二`启动应用程序与边车**

```ruby
docker-compose up -d

```

- - - - - -

###### **`三`将应用程序注册到Consul注册中心**

- **curl -k https://`Consul-Client-IP地址`:8501/v1/agent/service/register**
- **X-Consul-Token: 98e4ede4-271b-383b-94b7-c085137188fe `# 它是Bootstrap Token`**

```ruby
curl -k https://127.0.0.1:8501/v1/agent/service/register \
     --header "X-Consul-Token: 98e4ede4-271b-383b-94b7-c085137188fe" \
     --request PUT \
     --data '{
              "id": "static-server-0",
              "name": "static-server",
              "port": 8080,
              "connect": {
                  "sidecar_service": {}
              },
              "check": {
                  "http": "http://127.0.0.1:8080/health",
                  "method": "GET",
                  "interval": "1s",
                  "timeout": "1s"
              }
            }
     '


```

- - - - - -

- - - - - -

- - - - - -

###### 反注册

- **curl -k https://Consul-Client-IP地址:8501/v1/agent/service/deregister/`ServiceID`**

```ruby
curl -k https://127.0.0.1:8501/v1/agent/service/deregister/static-server-0 \
     --header "X-Consul-Token: 98e4ede4-271b-383b-94b7-c085137188fe" \
     --request PUT

```

- - - - - -

- - - - - -

- - - - - -

- - - - - -

- - - - - -

- - - - - -

- - - - - -

- - - - - -

- - - - - -

###### **`一`** 创建 **`static-client`** 应用程序的 docker-compose文件

```ruby
cat > docker-compose.yaml 
```

- - - - - -

###### **`二`启动应用程序与边车**

```ruby
docker-compose up -d

```

- - - - - -

###### **`三`将应用程序注册到Consul注册中心**

```ruby
curl -k https://127.0.0.1:8501/v1/agent/service/register \
     --header "X-Consul-Token: 98e4ede4-271b-383b-94b7-c085137188fe" \
     --request PUT \
     --data '{
              "id": "static-client-0",
              "name": "static-client",
              "port": 80,
              "connect": {
                  "sidecar_service": {
                      "proxy": {
                         "upstreams": [
                          {
                            "destination_name": "static-server",
                            "local_bind_port": 5000
                          }
                        ]
                      }
                  }
              },
              "check": {
                  "http": "http://127.0.0.1:80",
                  "method": "GET",
                  "interval": "1s",
                  "timeout": "1s"
              }
            }
     '


```

- - - - - -

###### data.json说明

```json
......
     --data '{
              "id": "static-client-0",                              // 当前应用程序自己的信息
              "name": "static-client",
              "port": 80,
              "connect": {
                  "sidecar_service": {
                      "proxy": {
                         "upstreams": [                             // 告诉当前应用程序，想要连通的服务有哪些
                          {
                            "destination_name": "static-server",    // 指定要连通的服务名
                            "local_bind_port": 5000                 // 跨服务网格访问时需要这个端口，每个配置各一个，不能重复; 例如： curl -sS http://static-server:5000 被代理到远程服务的 http://static-server:8080
                          },
                          {
                            "destination_name": "demo-two",         // 如果添加多个服务访问，就这样配置
                            "local_bind_port": 5001
                          }
                        ]
                      }
                  }
              },
              "check": {
                  "http": "http://127.0.0.1:80",                    // 当前应用程序自己的健康检查的地址，给个可以返回 200的http连接就可以
                  "method": "GET",
                  "interval": "1s",
                  "timeout": "1s"
              }
            }
     '

```

- - - - - -

- - - - - -

- - - - - -

###### 使用API创建 ServiceIntentions开放服务访问权限

```ruby
curl -k https://127.0.0.1:8501/v1/connect/intentions \
   --header "X-Consul-Token: 98e4ede4-271b-383b-94b7-c085137188fe" \
   --request POST \
   --data '{
               "SourceName": "static-client",
               "DestinationName": "static-server",
               "Action": "allow"
           }
   '


```

- - - - - -

- - - - - -

###### 使用API创建 ServiceResolver切换路由

```ruby
curl -k https://127.0.0.1:8501/v1/config \
   --header "X-Consul-Token: 98e4ede4-271b-383b-94b7-c085137188fe" \
   --request PUT \
   --data '{
              "Kind": "service-resolver",
              "Name": "static-server",
              "Redirect": {
                  "Service": "static-server",
                  "Datacenter": "dc2"
              },
              "Meta": {
                  "consul.hashicorp.com/source-datacenter": "dc1",
                  "external-source": "kubernetes"
              }
          }
   '


```

- - - - - -

- - - - - -

###### 测试跨注册中心访问 **static-client --&gt; static-server**

```ruby
docker exec -it static-client curl -sS http://127.0.0.1:5000
"hello world dc2-static-server"


docker exec -it static-client curl -sS http://static-server:5000
"hello world dc2-static-server"


```

- - - - - -

- - - - - -

- - - - - -

- - - - - -

- - - - - -

- - - - - -

##### 常用API

###### **注册空服务的做法**

**注册空服务的作用， 是为了解决跨不同数据中心， 进行服务访问， 因为跨数据中心访问当前集群的服务网格中， 必须要有一个对应的服务信息注册， 但本地并不需要一个真正的服务， 所以在本地可以注册一个空服务来满足路由的跳转功能**

```ruby
curl -k https://127.0.0.1:8501/v1/agent/service/register \
     --header "X-Consul-Token: 98e4ede4-271b-383b-94b7-c085137188fe" \
     --request PUT \
     --data '{
              "id": "static-server-0",
              "name": "static-server",
              "port": 8080,
              "connect": {
                  "sidecar_service": {}
              }
            }
     '


```

- - - - - -

###### 反注册

```ruby
curl -k https://127.0.0.1:8501/v1/agent/service/deregister/static-client-0 \
     --header "X-Consul-Token: 98e4ede4-271b-383b-94b7-c085137188fe" \
     --request PUT

```

- - - - - -

###### 删除ServiceResolver

```ruby
curl -k https://127.0.0.1:8501/v1/config/service-resolver/static-server \
   --header "X-Consul-Token: 98e4ede4-271b-383b-94b7-c085137188fe" \
   --request DELETE

```

- - - - - -

###### 查看ServiceResolver

```ruby
curl -k https://127.0.0.1:8501/v1/config/service-resolver \
   --header "X-Consul-Token: 98e4ede4-271b-383b-94b7-c085137188fe" \
   --request GET

```

- - - - - -

- - - - - -

- - - - - -

- - - - - -

- - - - - -

- - - - - -