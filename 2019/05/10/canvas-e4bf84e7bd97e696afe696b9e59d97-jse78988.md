---
title: 'Canvas 俄罗斯方块 JS版'
date: '2019-05-10T17:21:18+00:00'
status: publish
permalink: /2019/05/10/canvas-%e4%bf%84%e7%bd%97%e6%96%af%e6%96%b9%e5%9d%97-js%e7%89%88
author: 毛巳煜
excerpt: ''
type: post
id: 4595
category:
    - JavaScript
tag: []
post_format: []
hestia_layout_select:
    - sidebar-right
---
```
<pre data-language="HTML">```markup



  <meta charset="UTF-8"></meta>
  <style>
    html, body, canvas {
      padding: 0;
      margin: 0;
    }
  </style>




<canvas class="games-console" height="720" id="gamesConsole" style="background-color: #2b2b2b" width="480"></canvas>

```
```

```javascript
<script>
  /**
   * &#21021;&#22987;&#21270; Context
   */
  class GMCanvas {

    constructor(canvas) {

      this.ctx = canvas.getContext('2d');
      this.width = canvas.clientWidth;
      this.height = canvas.clientHeight;
      // &#24038;&#12289;&#21491;&#12289;&#19979; &#31227;&#21160;&#30340;&#36317;&#31163;
      this.distance = 40;
      // &#26041;&#22359;&#30340;&#21382;&#21490;&#35760;&#24405;
      this.history = [];
      //
      this.temp = [];
    }

    generateGraph() {
      // I &#27178;
      let IH = [{x: 0, y: 0, w: 38, h: 38}, {x: 40, y: 0, w: 38, h: 38}, {x: 80, y: 0, w: 38, h: 38}, {
        x: 120,
        y: 0,
        w: 38,
        h: 38
      }];
      // I &#31446;
      let IV = [{x: 0, y: 0, w: 38, h: 38}, {x: 0, y: 40, w: 38, h: 38}, {x: 0, y: 80, w: 38, h: 38}, {
        x: 0,
        y: 120,
        w: 38,
        h: 38
      }];
      // L &#27178;
      let LH = [{x: 0, y: 0, w: 38, h: 38}, {x: 40, y: 0, w: 38, h: 38}, {x: 80, y: 0, w: 38, h: 38}, {
        x: 80,
        y: -40,
        w: 38,
        h: 38
      }];
      // L &#31446;
      let LV = [{x: 0, y: 0, w: 38, h: 38}, {x: 0, y: 40, w: 38, h: 38}, {x: 0, y: 80, w: 38, h: 38}, {
        x: 40,
        y: 80,
        w: 38,
        h: 38
      }];

      let libs = [IH, IH, IH, IH];

      let random = Math.floor(Math.random() * (libs.length - 1));
      this.temp = libs[random];
    }

    /**
     * 1.&#29983;&#25104;&#32972;&#26223;&#32593;&#26684;
     * @param x
     * @param y
     * @param w
     * @param h
     */
    gmFillRectGrid(x, y, w, h) {
      this.ctx.save();
      this.ctx.lineWidth = 0.2;
      this.ctx.strokeStyle = 'hsla(200, 100%, 50%, .9)';
      this.ctx.strokeRect(x, y, w, h);
      this.ctx.restore();
    }

    /**
     * 2.&#29983;&#25104;&#26041;&#22359;
     * @param x
     * @param y
     * @param w
     * @param h
     */
    gmFillRect(x, y, w, h) {
      this.ctx.save();
      // &#35774;&#32622;&#30011;&#24067; &#22352;&#26631;&#31995;&#21407;&#28857;&#20301;&#32622;&#65288;&#27880;&#65306;&#26159;&#30011;&#31508;&#30456;&#23545;&#30340;&#20301;&#32622;&#65292;&#21363;&#65306;&#27599;&#27425;&#30011;&#26032;&#30340;&#22270;&#37117;&#20250;&#20415;&#23452;&#65289;
      this.ctx.translate(1, 1);
      // &#35774;&#32622;&#26041;&#22359;&#22635;&#20805;&#33394;
      this.ctx.fillStyle = 'hsla(200, 100%, 50%, .5)';
      // &#32472;&#21046;&#31354;&#24515;&#26041;&#22359;&#65292;&#40664;&#35748;&#40657;&#33394;
      this.ctx.fillRect(x, y, w, h);
      this.ctx.restore();
    }

    /**
     * 3.&#29983;&#25104;&#32593;&#26684; &#28216;&#25103;&#32972;&#26223;
     */
    generateGrid() {
      for (let i = 0; i < 216; i++) {
        this.gmFillRectGrid((i % 12) * 40, Math.floor(i / 12) * 40, 40, 40);
      }
    }

    /**
     * 4.&#37325;&#32472;&#26041;&#22359;
     */
    repaintRect(callback) {
      this.temp.map((rect) => {
        if (callback) {
          callback(rect);
        }
        this.gmFillRect(rect.x, rect.y, rect.w, rect.h);
      });
    }

    /**
     * 5.&#26356;&#26032;&#26041;&#22359;
     */
    gmUpdateRect() {
      this.ctx.clearRect(0, 0, this.width, this.height);
      this.generateGrid();
      // &#36733;&#20837;&#21382;&#21490;&#26041;&#22359;
      this.history.map((arr) => {
        arr.map((rect) => {
          this.gmFillRect(rect.x, rect.y, rect.w, rect.h);
        });
      });
    }

    /**
     * 6.&#21382;&#21490;&#35760;&#24405;(&#35760;&#24405;&#24050;&#32463;&#23436;&#25104;&#30340;&#26041;&#22359;)
     *
     * @param arr &#25968;&#25454;
     */
    saveHistory(arr) {
      if (Object.prototype.toString.call(arr) === '[object Array]') {
        this.history.push(arr);
      }
    }

    /**
     * &#24038;&#31227;
     */
    gmMoveLeft() {
      this.gmUpdateRect();
      // &#35745;&#31639; &#26159;&#21542;&#20301;&#31227;
      let result = this.temp.every((rect) => {
        // &#22914;&#26524;&#26377;&#19968;&#20010;&#26041;&#22359;&#36234;&#30028;&#65292;&#20854;&#20313;&#30340;&#23558;&#19981;&#22312;&#36827;&#34892;&#35745;&#31639;
        if (rect.x > 0) {
          return true;
        }
        // &#36234;&#30028;
        return false;
      });

      // &#37325;&#32472;&#26041;&#22359;
      this.repaintRect((rect) => {
        if (result) {
          rect.x -= this.distance;
        }
      });
    }

    /**
     * &#21491;&#31227;
     */
    gmMoveRight() {
      this.gmUpdateRect();
      // &#35745;&#31639; &#26159;&#21542;&#20301;&#31227;
      let result = this.temp.every((rect) => {
        // &#22914;&#26524;&#26377;&#19968;&#20010;&#26041;&#22359;&#36234;&#30028;&#65292;&#20854;&#20313;&#30340;&#23558;&#19981;&#22312;&#36827;&#34892;&#35745;&#31639;
        if (rect.x < this.width - this.distance) {
          return true;
        }
        // &#36234;&#30028;
        return false;
      });

      // &#37325;&#32472;&#26041;&#22359;
      this.repaintRect((rect) => {
        if (result) {
          rect.x += this.distance;
        }
      });
    }

    /**
     * &#19979;&#31227;
     */
    gmMoveDown() {
      this.gmUpdateRect();
      // &#35745;&#31639; &#26159;&#21542;&#20301;&#31227;
      let result = this.temp.every((rect) => {
        // &#22914;&#26524;&#26377;&#19968;&#20010;&#26041;&#22359;&#36234;&#30028;&#65292;&#20854;&#20313;&#30340;&#23558;&#19981;&#22312;&#36827;&#34892;&#35745;&#31639;
        if (rect.y >= this.height - this.distance) {
          // &#36234;&#30028;
          return false;
        }
        return true;
      });

      // &#37325;&#32472;&#26041;&#22359;
      this.repaintRect((rect) => {
        if (result) {
          rect.y += this.distance;
        }
      });

      // &#22914;&#26524;&#21457;&#29983;&#36234;&#30028;&#34920;&#31034;&#65292;&#23601;&#35753;&#26041;&#22359;&#21464;&#20026;&#21382;&#21490;
      if(!result) {
        // &#20445;&#23384;&#20026;&#21382;&#21490;&#26041;&#22359;
        this.saveHistory(this.temp);
        // &#37325;&#26032;&#38543;&#26426;&#29983;&#25104;&#27169;&#22411;
        this.generateGraph();
      }
    }

    gmTimer() {
      // &#27599;&#31186;&#25191;&#34892;&#19968;&#27425;
      this.intervalId = setInterval(() => {
        this.gmMoveDown();
      }, 1000);
    }

  }
</script>
<script>

  let canvas = document.getElementById('gamesConsole');
  let gmCanvas = new GMCanvas(canvas);

  function startGame() {
    // &#29983;&#25104;&#32593;&#26684; &#28216;&#25103;&#32972;&#26223;
    gmCanvas.generateGrid();
    // &#29983;&#25104;&#22270;&#24418;&#27169;&#22411;
    gmCanvas.generateGraph();
    // &#37325;&#32472;&#22270;&#24418;
    gmCanvas.repaintRect();
    // &#24320;&#21551;&#23450;&#26102;&#22120;
    gmCanvas.gmTimer();
  }

  startGame();
</script>

<script>
  document.onkeydown = function (e) {
    switch (e.key) {
      case 'ArrowUp':
        break;
      case 'ArrowDown':
        gmCanvas.gmMoveDown();
        break;
      case 'ArrowLeft':
        gmCanvas.gmMoveLeft();
        break;
      case 'ArrowRight':
        gmCanvas.gmMoveRight();
        break;
    }
  }
</script>

```

```
<pre data-language="HTML">```markup




```
```