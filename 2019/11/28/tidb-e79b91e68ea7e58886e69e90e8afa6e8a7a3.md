---
title: 'TIDB 监控分析详解'
date: '2019-11-28T08:51:39+00:00'
status: publish
permalink: /2019/11/28/tidb-%e7%9b%91%e6%8e%a7%e5%88%86%e6%9e%90%e8%af%a6%e8%a7%a3
author: 毛巳煜
excerpt: ''
type: post
id: 5161
category:
    - TiDB
tag: []
post_format: []
hestia_layout_select:
    - sidebar-right
---
##### 一、Cluster-Overview 面板

###### System Info

- `CPU Usage`：CPU 使用率，最大为 100%
- `IO Util`：磁盘使用率，最高为 100%，一般到 80%-90% 就需要考虑加节点(**原因TiKV的磁盘负载太高，并`不是因为硬盘空间不足`**)
- `Memory Available`：剩余内存大小
- `Network Traffic`：网卡流量统计
- `TCP Retrans`：网络监控，TCP 相关信息统计
- `Vcores`：CPU 核心数量
- `Memory`：内存总大小
- `Load [1m]`：1 分钟的负载情况

###### TiDB

- **`Statement OPS`：SQL 执行数量统计（包含 select、insert、update 等）**
- **`Duration`：SQL 执行的时间（主看99 95按照百分位计算方式——把这一段时间所有sql的响应时间放到一个列表里排序，第99%响应时间是……s）**
- `QPS By Instance`：每个 TiDB 上的 QPS
- `Failed Query OPM`：失败 SQL 的统计，例如语法错误、主键冲突等  
  <table><thead><tr><th align="left">**异常类型**</th><th align="center">**异常码**</th><th align="center">**引发异常的IP地址**</th><th align="center">**异常发生次数(最大值)**</th><th align="center">**异常发生次数(当前值)**</th></tr></thead><tbody><tr><td align="left">parser</td><td align="center">`1064`</td><td align="center">172.160.180.33:10080</td><td align="center">1.333</td><td align="center">0</td></tr><tr><td align="left">planner</td><td align="center">`1055`</td><td align="center">172.160.180.33:10080</td><td align="center">5.333</td><td align="center">0</td></tr><tr><td align="left">schema</td><td align="center">`1146`</td><td align="center">172.160.180.33:10080</td><td align="center">1.333</td><td align="center">0</td></tr><tr><td align="left">...</td><td align="center">...</td><td align="center">...</td><td align="center">...</td><td align="center">...</td></tr></tbody></table>
- **`Connection count`：每个 TiDB 的连接数（负载不均匀原因有1、可能是配置HA配置原因导致的-如会话保持等2、后期可能会详细化如running状态的waiting状态的sleeping等）**
- `Heap Memory Usage`：每个 TiDB 使用的堆内存大小
- `Transaction OPS`：事务执行数量统计
- `Transaction Duration`：事务执行的时间
- `KV Cmd OPS`：KV 命令执行数量统计
- `KV Cmd Duration 99`：KV 命令执行的时间
- `PD TSO OPS`：TiDB 从 PD 获取 TSO 的数量
- **`PD TSO Wait Duration`：TiDB 从 PD 获取 TS 的时间（正常情况下99%应该为ms级，参数飘升pdserver瓶颈或是发杂的sql解析——每个sql都要到pd拿一个tso）**100ms
- `TiClient Region Error OPS`：TiKV 返回 Region 相关错误信息的数量
- `Load Schema Duration`：TiDB 从 TiKV 获取 Schema 的时间
- **`Lock Resolve OPS`：事务冲突相关的数量（锁冲突数量超过两位数几百或是更高不正常，事务锁等待）**
  
  <table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>---</td><td>从`lock resolve ops`以及`kv backoff ops`两个界面中可以发现当前系统存在锁冲突的情况</td></tr><tr><td>expired</td><td>重试次数已过期的事务数</td></tr><tr><td>not\_expired</td><td>未过期的事务数</td></tr><tr><td>query\_resolve\_lock\_lite</td><td></td></tr><tr><td>query\_resolve\_locks</td><td></td></tr><tr><td>query\_txn\_status</td><td></td></tr><tr><td>query\_txn\_status\_committed</td><td></td></tr><tr><td>query\_txn\_status\_rolled\_back</td><td></td></tr><tr><td>resolve</td><td>重试成功的事务数</td></tr><tr><td>wait\_expired</td><td>等待重试的事务数</td></tr></tbody></table>
- **`KV Backoff OPS`：TiKV 因事务冲突，导致事务重试的次数**; 会受到TiKV的 **[server report failures](#jump)** 模块数据影响
  
  <table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>pdRPC</td><td></td></tr><tr><td>regionMiss</td><td></td></tr><tr><td>tikvLockFast</td><td>表示`读写`冲突</td></tr><tr><td>tikvRPC</td><td></td></tr><tr><td>txnLock</td><td>表示遇到`写写`冲突</td></tr><tr><td>updateLeader</td><td></td></tr></tbody></table>

###### PD

- `Storage Capacity`：TiDB 集群总可用数据库空间大小
- `Current Storage Size`：TiDB 集群目前已用数据库空间大小
- `Number of Regions`：当前集群的 Region 总量
- `Leader Balance Ratio`：Leader 数量最多和最少节点相差的百分比，一般小于 5%，节点重启时会有比较大的波动
- `Region Balance Ratio`：Region 数量最多和最少节点相差的百分比，一般小于 5%，新增/下线节点时相差比较大
- `Store Status`：集群 TiKV 节点的状态
- `Up Stores`：正常运行的 TiKV 节点数量
- `Disconnect Stores`：短时间内通信异常的 TiKV 节点数量
- `LowSpace Stores`：剩余可用空间小于 20% 的 TiKV 节点数量
- `Down Stores`：停止工作的 TiKV 节点数量，如果大于 0，说明有节点不正常
- **`Offline Stores`：正在下线的 TiKV 节点数量（正在下线的 TiKV 节点还在提供服务）**
- `Tombstone Stores`：下线成功的 TiKV 节点数量
- `99% completed_cmds_duration_seconds`：单位时间内，99% 的 pd-server 请求执行时间小于监控曲线的值，一般
- `handle_requests_duration_seconds`：PD 发送请求的网络耗时
- **`Region Health`：（正常情况下应该都是0）**
  
  <table><thead><tr><th align="left">**参数**</th><th>**max**</th><th>**avg**</th><th>**current**</th><th>**说明**</th></tr></thead><tbody><tr><td align="left">down-peer-region-count</td><td>0</td><td>0</td><td>0</td><td>有副本状态为 down 的 region 总数</td></tr><tr><td align="left">empty-region-count</td><td>2.867 K</td><td>2.864 K</td><td>2.859 K</td><td>有副本状态为 空 的 region 总数, 如果数量小暂时没有影响, 数量大要进行合并处理：**[参考文档](https://asktug.com/t/topic/2407/4 "参考文档")**</td></tr><tr><td align="left">extra-peer-region-count</td><td>0</td><td>0</td><td>0</td><td>多副本的 Region 总数</td></tr><tr><td align="left">incorrect-namespace-region-count</td><td>0</td><td>0</td><td>0</td><td>有副本不符合 namespace 约束的 Region 总数</td></tr><tr><td align="left">learner-peer-region-count</td><td>0</td><td>0</td><td>0</td><td>状态为 learner 的 region 总数</td></tr><tr><td align="left">miss-peer-region-count</td><td>0</td><td>0</td><td>0</td><td>缺副本的 Region 总数</td></tr><tr><td align="left">offline-peer-region-count</td><td>0</td><td>0</td><td>0</td><td>状态为 offline 的 region 总数</td></tr><tr><td align="left">pending-peer-region-count</td><td>0</td><td>0</td><td>0</td><td>有副本状态为 Pending 的 Region 的总数</td></tr></tbody></table>
- `Hot write region's leader distribution`：写热点
- `Hot read region's leader distribution`：读热点

###### TiKV

- `leader`：各个 TiKV 节点上 Leader 的数量分布
- `region`：各个 TiKV 节点上 Region 的数量分布
- `CPU`：各个 TiKV 节点的 CPU 使用率
- `Memory`：各个 TiKV 节点的内存使用量
- `store size`：各个 TiKV 节点存储的数据量
- `cf size`：集群不同 CF 存储的数据量
- **`channel full`：正常情况显示 No data，如果有了监控值，说明对应 TiKV 节点的消息处理不过来了（堵塞不应该有数据）**
- **<a id="jump">server report failures</a>：正常情况显示 No data，如果出现了 Unreachable，说明 TiKV 之间通信有问题（不应该有数据）; 一般重启TiKV时也会产生数据。**
- **`scheduler pending commands`：写入堆积的数量，偶尔出现峰值属于正常现象（热点情况，硬件I/O或是内存导致堆积）**
- `coprocessor pending requests`：正常情况监控为 0 或者数量很少
- `coprocessor executor count`：不同类型的查询操作数量
- `coprocessor request duration`：TiKV 中查询消耗的时间
- `raft store CPU`：raftstore 线程的 CPU 使用率，线程数量默认为 2 (通过 raftstore.store-pool-size 配置)。如果单个线程使用率超过 80%，说明使用率很高，在`TiKV-Details --> Thread CPU` 模块中也可查看; **[详见官方文档](https://pingcap.com/docs-cn/stable/reference/best-practices/massive-regions/#%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98 "详见官方文档")**
- `Coprocessor CPU`：TiKV 查询线程的 CPU 使用率，和业务相关，复杂查询会使用大量的 CPU 资源

- - - - - -

- - - - - -

##### 二、Cluster-TiKV-Details 面板

###### Thread CPU

- **`Raft store CPU`：raftstore 线程的 CPU 使用率，通常应低于 80%（2.0版本80-90%，3.0版本多线程默认两个线程可以调整:180-190%瓶颈，添加kv服务器）**
- `Async apply CPU`：async apply 线程的 CPU 使用率，通常应低于 90%
- `Scheduler CPU`：scheduler 线程的 CPU 使用率，通常应低于 80%
- `Scheduler worker CPU`：scheduler worker 线程的 CPU 使用率
- `Storage ReadPool CPU`：Readpool 线程的 CPU 使用率
- **`Coprocessor CPU`：coprocessor 线程的 CPU 使用率（负责处理region扫描的线程，低于80%，增高可能是热点现象导致的）**
- `Snapshot worker CPU`：snapshot worker 线程的 CPU 使用率
- `Split check CPU`：split check 线程的 CPU 使用率
- `RocksDB CPU`：RocksDB 线程的 CPU 使用率
- **`gRPC poll CPU`：gRPC 线程的 CPU 使用率，通常应低于 80%（负责kv节点之间通信，默认4个线程，可以调整，sql 对应的region节点离散数量多导致增高）**
- **`Lock manager --> Detect error`：查看是否存在死锁**  
  <table><thead><tr><th align="left">**参数**</th><th>**max**</th><th>**avg**</th><th>**说明**</th></tr></thead><tbody><tr><td align="left">deadlock</td><td>0 ops</td><td>0 ops</td><td>死锁数量</td></tr><tr><td align="left">dropped</td><td>0.1 ops</td><td>0.1 ops</td><td></td></tr><tr><td align="left">leader\_not\_found</td><td>0 ops</td><td>0 ops</td><td></td></tr><tr><td align="left">not\_leader</td><td>15.2 ops</td><td>7.6 ops</td><td></td></tr><tr><td align="left">reconnect\_leader</td><td>15.4 ops</td><td>7.4 ops</td><td></td></tr></tbody></table>

###### Coprocessor Detail

**`Wait duration`**: 表示这个语句在 TiKV 的等待时间之和，**因为 TiKV 的 Coprocessor `线程数`是`有限`的，当所有的 Coprocessor 线程都在工作的时候，`请求会排队`** ；当队列中有某些请求耗时很长的时候，后面的请求的等待时间都会增加。**[解决方案](http://www.dev-share.top/2019/08/29/tidb-%E5%AE%9A%E4%BD%8D%E6%85%A2%E6%9F%A5%E8%AF%A2/ "解决方案")**

- - - - - -

- - - - - -

##### 三、

- - - - - -

- - - - - -

##### 告警

TiDB的告警系统目前还是通过AlertManager组件是实现，具体配置的配置文件在  
`tidb-ansile/roles/prometheus/files` 下面针对不同的监控对象对应 的配置文件  
告警级别分为三种：**warning、emergency、critical**

###### 常见的TiDB告警项识别和应对

[官方告警参数参考](https://pingcap.com/docs-cn/stable/reference/alert-rules/)

**主机级别：**

<table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">`NODE_disk_used_more_than_80%(emergency)`</td><td align="left"> 节点的磁盘空间使用</td></tr><tr><td align="left">`NODE_disk_inode_more_than_80%(emergency)`</td><td align="left"></td></tr><tr><td align="left">`NODE_disk_redonly(emergency)`</td><td align="left"></td></tr><tr><td align="left">`NODE_memory_used_more_than_80%(critical)`</td><td align="left"> 节点的内存使用率</td></tr><tr><td align="left">`NODE_node_overload(warning)`</td><td align="left"></td></tr><tr><td align="left">**以下参数针对pcre-SSD(自身的服务器可以适当提高)：**</td><td align="left"></td></tr><tr><td align="left">`NODE_cpu_used_more_than_80%(warning)`</td><td align="left"></td></tr><tr><td align="left">`NODE_tcp_estab_num_more_than_50000(warning)`</td><td align="left"> tcp的建立超过50000个</td></tr><tr><td align="left">`NODE_disk_read_latency_more_than_32ms(warning)`</td><td align="left"> 磁盘都延迟</td></tr><tr><td align="left">`NODE_disk_write_larency_more_than_16ms(warning)`</td><td align="left"> 磁盘写延迟</td></tr></tbody></table>

**tidb-server级别：**

<table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">`TiDB_schema_error(emergency)`</td><td align="left"> 获取源数据信息失败，可能会造成tidb不可用; eg:tidb和tikv之间网络隔离或是tikv节点cpu负载高</td></tr><tr><td align="left">`TiDB_tikvclient_region_err_total(emergency)`</td><td align="left"> increase\[10m\]&gt;6000; 少量合理；短时间内大量的err，eg：节点挂掉</td></tr><tr><td align="left">`TiDB_domain_load_schema_tatal(emergency)`</td><td align="left"> increase{failed}\[10m\]&gt;10</td></tr><tr><td align="left">`TiDB_monitor_keep_alive(emergency)`</td><td align="left"> increase\[10m\] </td></tr><tr><td align="left">`TiDB_server_panic_total(critical)`</td><td align="left"> TiDB server panic; 不兼容mysql的语法</td></tr><tr><td align="left">`TiDB_memory_abnormal(warning)`</td><td align="left"> TiDB heap memory usage is over 10 GB; 一条sql使用内存</td></tr><tr><td align="left">`TiDB_query_duration(warning)`</td><td align="left"> 99百分位duration&gt;1s; 超过99&gt;1不正常</td></tr><tr><td align="left">`TiDB_server_event_error(warning)`</td><td align="left"> increase{server\_start | server\_hang}\[15m\]&gt;0</td></tr><tr><td align="left">`TiDB_tikvclient_backoff_count(warning)`</td><td align="left"> increase\[10m\]&gt;10; tidb和tikv之间backoff</td></tr><tr><td align="left">`TiDB_monitor_time_jumpback_error(warning)`</td><td align="left"> time\_jump\_back</td></tr><tr><td align="left">`TiDB_ddl_warting_jobs(warning)`</td><td align="left"> sum(waiting jobs)&gt;5</td></tr></tbody></table>

**tikv-server级别：**

<table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">`TiKV_memory_used_too_fast(emergency)`</td><td align="left"> tikv节点对应内存使用量过快</td></tr><tr><td align="left">**`TiKV_GC_can_not_work(emergency)`**</td><td align="left"> **tikv有mvcc机制（数据多版本）——如果GC出现问题会导致过期的数据无法清理空间增大**</td></tr><tr><td align="left">**`TiKV_server_report_failure_msg_total(critical)`**</td><td align="left">**十分钟之内unreachable超过10次, 不断oom等状况导致**</td></tr><tr><td align="left">**`TiKV_channel_full_total(critical)`**</td><td align="left"> **内部通道队列打满，典型写堆积或scheduler pending**</td></tr><tr><td align="left">**`TiKV_write_stall(critical)`**</td><td align="left"> **I/O满等**</td></tr><tr><td align="left">**`TiKV_raft_log_lag(critical)`**</td><td align="left"> **99百分位的raft\_log滞后&gt;5000, 写入压力过大可能导致**</td></tr><tr><td align="left">`TiKV_async_request_snapshot_duration_seconds(criticl)`</td><td align="left"> pd调度的时候</td></tr><tr><td align="left">`TiKV_async_request_write_duration_seconds(critical)`</td><td align="left"> 推荐查看下磁盘状态</td></tr><tr><td align="left">`TiKV_coprocessor_request_wait_seconds(critical)`</td><td align="left"> 99.99百分位wait超过10s</td></tr><tr><td align="left">**`TiKV_raftstore_thread_cpu_seconds_total(critica)`**</td><td align="left"> **一分钟内的raftstore线程CPU使用率超过了80%，集群整体表现卡顿。  
 处理办法tikv实例数太少，导致压力不分散，可以添加tikv实例，或是等待3.0的多线程版本**</td></tr><tr><td align="left">**`TiKV_raft_append_log_duration_secs(critical)`**</td><td align="left"> **磁盘资源使用关系紧密一点**</td></tr><tr><td align="left">`TiKV_scheduler_latch_wait_duration_seconds(critical)`</td><td align="left"> kv里等待锁的时间比较长 产生pending了</td></tr><tr><td align="left">`TiKV_thread_apply_worker_cpu_seconds(critical)`</td><td align="left"> 对应的cpu的消耗，超过90%</td></tr><tr><td align="left">`TiKV_tickclient_gc_action_fail(critical)`</td><td align="left"> gc长时间执行失败</td></tr></tbody></table>

**pd-server级别：**

<table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">**`PD_cluster_offline_tikv_nums(emergency)`**</td><td align="left"> **pd长时间（默认配置是 30 分钟）没有收到tikv的心跳,处理方法：检查 TiKV 进程是否正常、网络是否隔离以及负载是否过高，并尽可能地恢复服务。  
 如果确定 TiKV 无法恢复，可做下线处理。**</td></tr><tr><td align="left">`PD_etcd_write_disk_latency(critical)`</td><td align="left"> etcd写盘99 duration&gt;1s</td></tr><tr><td align="left">**`PD_miss_peer_region_count(critical)`**</td><td align="left"> **缺失副本的region数量超过100 #Region 的副本数小于 max-replicas 配置的值。  
 这通常是由于 TiKV 宕机等问题导致一段时间内一些 Region 缺副本，下线 TiKV 节点也会导致少量 Region 缺副本（对于有 pending peer 的 Region 会走先减后加的流程）。  
 解决方法：查看是否有 TiKV 宕机或在做下线操作，尝试定位问题产生的原因。观察 region health 面板，查看 miss\_peer\_region\_count 是否在不断减少。**</td></tr></tbody></table>

- - - - - -

- - - - - -

##### 常见问题对应的面板 **[常见问题](http://www.dev-share.top/2019/08/21/tidb-%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98/ "常见问题")**

###### 1、压测时 QPS上不去?

- 首先需要查看 OverView  
  面板上，集群的资源使用情况，比如`CPU是否超过80%`，网络流量是否快达到阈值，`磁盘IO使用率是否超过80%`等。
- 如果是压测偏TP点查写的业务逻辑，大概率瓶颈会出在 `tidb-server` 上， 如果是压偏 AP 的范围查询业务逻辑，有可能瓶颈会出在 `tikv-server 的 Coprocessor` 上， 如果是压测集中写入场景，有可能瓶颈会出在 `tikv-server 的 raft-store_cpu` 或 `scheduler task pending` 上
- 如果确认集群资源没有瓶颈，需要往前排查，例如 proxy 负载是否开启多线程转发，压测程序是否会出现瓶颈，以及压测逻辑是否存在串行队列引起堵塞等

###### 2、遇到热点情况?

- 热点情况可以通过前面介绍的 `raft/coprocessor CPU` 监控指标判断出来，如果发现 tikv 各节点的 CPU使用情况非常不均匀，几乎可以判断是遇到了热点情况。
- 至于热点的原因可能有很多种，需要具体分析，常见有自增主键引起的热点写入，基于时间戳的索引字段也会引起写热点现象，业务逻辑查询存在热点数据集中在一个 region 上引起读热点
- 需要查看监控面板 `Cluster-PD --> Statistics-hotspot`, 具体参数解释参照 **[官方文档说明](https://pingcap.com/docs-cn/stable/reference/key-monitoring-metrics/pd-dashboard/#statistics---hotspot "官方文档说明")**

###### 3、数据冲突严重？

- 通过 `Lock Reslove OPS` 指标可以判断是否遇到冲突的场景，一般是需要在业务侧考点如何避免冲突的场景，或者尝试降低事务提交的 batch 的大小。
- 另外事务在二阶段提交时，如果读取这些 key 也是可能会引起 `lock reslove` 的动作，所以查询的时候尽量缩小范围只查必要的数据也有助于降低遇到冲突的概率
- 另外如果提交过慢也会加大冲突的概率，需要判断当前事务提交的耗时是否合理也有助于分析冲突的场景

###### 4、查询慢？

- 通过 TiDB 面板的 `Duration` 指标可以大概得出 SQL 的响应时间是否符合预期
- 另外通过 TiKV 面板的 `Coprocessor` 子页，可以查询到更具体的信息，例如 `Scan keys` 是否符合预期、`Request Duration` 高还是 `Wait Duration` 高？
- 再结合 `RocksDB-kv` 子页上的 `Get/Seek duration` 以及 `block cache hit` 来辅助判断, 如果发现命中率出现大幅度下降或抖动，基本可以定位为`慢 SQL`问题；否则倾向于怀疑是`小表的大量并发`读取导致的。**[官方文档-热点处理思路](https://book.tidb.io/session4/chapter7/hotspot-resolved.html "官方文档-热点处理思路")**
- 另外分析 `slow-log`，找到最慢或占比最高的 SQL， 再结合 explain 方法来查看执行计划是否合理

###### 5、写入慢？

- 通过 TiDB 面板的 `Trasaction` 子页上面的 `Duration` 可以得出当前事务处理的时间是否符合预期
- 结合 TiKV 面板的 `Thead CPU` 子页上的 `Raft store CPU` 情况看是否快达到默认的 200% 阈值，以及是否存在热点写入的情况
- 一般来说，更快的磁盘，`100左右的 batch commit`, 更高的并发写入会得到更优的写入吞吐