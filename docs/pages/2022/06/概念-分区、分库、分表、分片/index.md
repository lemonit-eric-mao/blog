---
title: "概念-分区、分库、分表、分片"
date: "2022-06-20"
categories: 
  - "数据库"
---

## 表分区

**表分区**是一种**逻辑**上的**水平分表**，在**物理层**面还是**一张表**

* * *

* * *

* * *

## **一、`为什么要分库分表？`**

### **数据库瓶颈**

> - **`IO`瓶颈**
>     - 磁盘读IO瓶颈，热点数据太多，数据库缓存放不下，每次查询时会产生大量的IO，降低查询速度。这种场景优先考虑 --> **分库和垂直分表**
>     - 网络IO瓶颈，请求的数据太多，网络带宽不够。这种场景优先考虑 --> **分库**

* * *

> - **`CPU`瓶颈**
>     - SQL问题，如SQL中包含**join，group by，order by**，非索引字段条件查询等，增加CPU运算的操作。这种场景优先考虑 --> **SQL优化，建立合适的索引**。
>     - 单表数据量太大，查询时扫描的行太多，SQL效率低，CPU率先出现瓶颈。这种场景优先考虑 --> **水平分表**。

* * *

## **二、概念-`如何分库分表？`**

### **水平分`表`**

> - **概念**：
>     - 以**字段**为依据 ，按照一定策略（hash、range等），将**一个表**中的数据拆分到**多个表**中。
> - **结果**：
>     - 每个**表**的**结构**都一样；
>     - 每个**表**的**数据**都不一样，没有交集；
>     - 所有**表**的**并集**是全量数据；
> - **适合场景**：
>     - 系统绝对并发量并没有上来，只是单表的数据量太多，影响了SQL效率，加重了CPU负担，以至于成为瓶颈。
> - **分析角度**：
>     - 表的数据量少了，单次SQL执行效率高，自然减轻了CPU的负担。

* * *

### **水平分`库`**

> - **概念**：
>     - 以**字段**为依据 ，按照一定策略（hash、range等），将**一个库**中的数据拆分到**多个库**中。
> - **结果**：
>     - 每个**库**的**结构**都一样；
>     - 每个**库**的**数据**都不一样，没有交集；
>     - 所有**库**的**并集**是全量数据；
> - **适合场景**：
>     - 系统绝对并发量上来了，`分表`难以根本上解决问题，并且还没有明显的业务归属来垂直分库。
> - **分析角度**：
>     - 库多了，io和cpu的压力自然可以成倍缓解。

* * *

* * *

### **垂直分`表`**

> - 垂直分表是基于数据库中的"列"进行，某个表字段较多，可以新建一张扩展表，将不经常用或字段长度较大的字段拆分出去到扩展表中。

* * *

> - **概念**：
>     - 以**字段**为依据，按照字段的活跃性，将**表中字段**拆到**不同的`表`（主表 和 扩展表）**中。
> - **结果**：
>     - 每个**表**的**结构**都不一样；
>     - 每个**表**的**数据**也不一样，一般来说，每个表的**字段**至少有一列交集，一般是主键，用于关联数据；
>     - 所有**表**的**并集**是全量数据；
> - **适合场景**：
>     - 系统绝对**并发量`并没有`上来**，表的记录并不多，但是字段多，并且**热点**数据和**非热点**数据在一起，**单行数据**所需的存储空间较大。 以至于数据库缓存的数据行减少，查询时会去读磁盘数据产生**大量的随机读IO**，产生IO瓶颈。
> - **分析角度**：
>     - 可以用列表页和详情页来帮助理解。 垂直分表的拆分原则是将 **`热点`数据（可能会冗余经常一起查询的数据）放在一起作为`主表`，`非热点`数据放在一起作为`扩展表`**。 这样更多的热点数据就能被缓存下来，进而减少了随机读IO。拆了之后，要想获得全部数据就需要关联两个表来取数据。 但记住，**千万别用join**，因为join不仅会增加CPU负担并且会讲两个表耦合在一起（必须在一个数据库实例上）。 关联数据，应该在业务Service层做文章，分别获取主表和扩展表数据然后用关联字段关联得到全部数据。

* * *

### **垂直分`库`**

> - 垂直分库就是根据业务耦合性，将关联度低的不同表存储在不同的数据库。做法与大系统拆分为多个小系统类似，按业务分类进行独立划分。与"微服务治理"的做法相似，每个微服务使用单独的一个数据库。

* * *

> - **概念**：
>     - 按照业务归属不同，将**不同的表**拆分到**不同的库**中 。
> - **结果**：
>     - 每个**库**的**结构**都不一样；
>     - 每个**库**的**数据**也不一样，没有交集；
>     - 所有**库**的**并集**是全量数据；
> - **适合场景**：
>     - 系统绝对**并发量`已经`上来了**，并且可以抽象出单独的业务模块。
> - **分析角度**：
>     - 到这一步，基本上就可以服务化了。例如，随着业务的发展一些公用的配置表、字典表等越来越多，这时可以将这些表拆到单独的库中，甚至可以服务化。
>     - 再有，随着业务的发展孵化出了一套业务模式，这时可以将相关的表拆到单独的库中，甚至可以服务化。

* * *

* * *

* * *

## **三、`数据量在什么情况下需要分表？`**

**数据量在什么情况下需要分表？** 当**oracle**单表的数据量大于`2000`万行时，建议进行水平分拆。 当**mysql**单表的数据量大于`1000`万行时，建议进行水平分拆。 当**SQLServer**单表的数据量大于`1000`万行时，建议进行水平分拆。

* * *

* * *

* * *

## **四、`什么是数据分片？`**

**数据分片**

> - 指按照某个维度将存放在**单一数据库中的数据分散地存放至多个数据库或表中**以达到提升性能瓶颈以及可用性的效果。
>     - **数据分片**的有效手段是**对关系型数据库进行`分库`和`分表`**。
> - **分库**和**分表**均可以有效的避免由数据量超过可承受阈值而产生的查询瓶颈。
>     - 除此之外，**分库**还能够用于**有效的分散对数据库单点的访问量**；
>     - **分表**虽然无法缓解数据库压力，但却能够提供**尽量将分布式事务**转化为**本地事务的`可能`**，一旦涉及到**跨库的更新操作**，**分布式事务**往往会**使问题变得复杂**。
>     - 使用**多主多从**的**分片**方式，可以有效的避免数据单点，从而提升数据架构的可用性。
> - 通过**分库**和**分表**进行数据的拆分来使得各个表的数据量保持在阈值以下，以及对流量进行疏导应对高访问量，是应对高并发和海量数据系统的有效手段。
>     - 数据**分片**的拆分方式又分为**垂直分片**和**水平分片**。

**垂直分片**

> - **按照业务拆分**的方式称为**垂直分片**，又称为**纵向拆分**，**它的核心理念是专库专用**。
>     - 在**拆分之前**，一个数据库由多个数据表构成，每个表对应着不同的业务。
>     - 而**拆分之后**，则是按照业务将表进行归类，分布到不同的数据库中，从而将压力分散至不同的数据库。
> - **垂直分片**往往需要对架构和设计进行调整。
>     - 通常来讲，是来不及应对互联网业务需求快速变化的；而且，它也并无法真正的解决单点瓶颈。
>     - 垂直拆分可以缓解数据量和访问量带来的问题，但无法根治。
>     - 如果垂直拆分之后，表中的**数据量依然超过单节点所能承载的阈值**，则需要**水平分片**来进一步处理。

**水平分片**

> - **水平分片**又称为横向拆分。
>     - 相对于垂直分片，它不再将数据根据业务逻辑分类，而是通过某个字段（或某几个字段），根据某种规则将数据分散至多个库或表中，每个分片仅包含数据的一部分。
>     - 例如：根据主键分片，偶数主键的记录放入 0 库（或表），奇数主键的记录放入 1 库（或表）
> - **水平分片**从理论上突破了单机数据量处理的瓶颈，并且扩展相对自由，**是数据分片的标准解决方案**。
>     

**挑战**

> - 虽然数据分片解决了性能、可用性以及单点备份恢复等问题，但分布式的架构在获得了收益的同时，也引入了新的问题。
> - 面对如此散乱的分片之后的数据，**应用开发工程师**和**数据库管理员**对**数据库的操作**变得**异常繁重**就是其中的重要挑战之一。
>     - 他们需要知道**数据**需要**从哪个具体的数据库**的**子表**中获取。
> - 另一个挑战则是，能够正确的运行在单节点数据库中的 SQL，**在分片之后的数据库中并不一定能够正确运行**。
>     - 例如，分表导致表名称的修改，或者分页、排序、聚合分组等操作的不正确处理。
> - **跨库事务**也是分布式的数据库集群要面对的棘手事情。
>     - 合理采用分表，可以在降低单表数据量的情况下，尽量使用本地事务，善于使用同库不同表可有效避免分布式事务带来的麻烦。
>     - 在不能避免跨库事务的场景，有些业务仍然需要保持事务的一致性。 而基于 XA 的分布式事务由于在并发度高的场景中性能无法满足需要，并未被互联网巨头大规模使用，他们大多采用**最终一致性**的**柔性事务`代替`强一致事务**。

* * *

* * *

* * *

### 参考资料

- **[数据库分库分表是什么，什么情况下需要用分库分表](https://www.jb51.net/article/208140.htm "数据库分库分表是什么，什么情况下需要用分库分表")**
- **[SQL在什么情况下要分表、分库？](https://www.zhihu.com/question/446688267/answer/1753142269 "SQL在什么情况下要分表、分库？")**
- **[MySQL数据库之分库分表方案](https://zhuanlan.zhihu.com/p/467721569 "MySQL数据库之分库分表方案")**
- **[数据分片](https://shardingsphere.apache.org/document/current/cn/features/sharding/)**

* * *

* * *

* * *
