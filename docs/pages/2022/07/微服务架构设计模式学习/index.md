---
title: "微服务架构设计模式学习"
date: "2022-07-25"
categories: 
  - "cloudnative"
  - "非技术文档"
---

### 微服务拆分指导原则

1. 在定义类的职责时，应该遵循**`单一职责`原则**
2. 反类组成包时，应该遵循**`闭包`原则**

**[具体参考 OOD原则](http://www.dev-share.top/2017/11/16/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f-%e5%8e%9f%e5%88%99/ "具体参考 OOD原则")**

* * *

### 拆分单体应用的难点

- **网络延迟**：
    
    - 对服务的特定分解导致两个服务之间的大量往返调用； 解决：把多个相关服务组合在一起，用编程语言的函数调用替换进程间通信；或者实施批处理API在一次往返中获取多个对象；
- **同步进程间通信导致可用性降低**
    
    - 使用REST协议同步调用其他服务时，会降低service的可用性；
- **在服务之间维护数据一致性**
    
    - 当一个系统操作需要修改多个服务的数据时，需要维护数据的一致性；
- **获取一致的数据视图**
    
    - 无法跨多个数据库获得真正一致的数据视图；
- **上帝类阻碍了拆分**
    
    - 上帝类是在整个应用程序中使用的全局类，通常与多个服务的状态与行为绑定；

* * *

### 微服务架构的弊端

微服务的优点大家都知道，就不说了

> - **微服务的拆分和定义是一项挑战**
>     - 采用微服务架构首当其冲的问题，就是**根本没有**一个具体的、良好定义的算法可以完成服务的拆分工作。
>     - 如果对系统的服务拆分出现了偏差，你很有可能会构建出一个**分布式的单体应用**，例如：一个包含了一大堆互相之间紧耦合的服务，却又必须部署在一起的所谓分布式系统。这将会把单体架构和微服务架构两者的**弊端集于一身**。

* * *

> - **分布式系统带来的各种复杂性，使开发、测试和部署变得更困难**
>     1. 开发人员必须处理创建**分布式系统的`额外复杂性`**。
>     2. 服务必须使用**进程间通信**机制。
>     3. 每个服务都有自己数据库，实现跨服务的事务和查询成为一项挑战。如：**如何实现分布式事务**
>     4. 微服务的应用程序无法使用简单查询从多个服务中检索数据。相反，它必须使用**API组合**或**CQRS视图**实现查询
>     5. 要成功部署微服务，需要高度自动化的基础设施，必须使用**自动化部署工具**、**产品化的PaaS平台**、**容器编排平台**等技术。

* * *

> - **当部署跨越多个服务的功能时需要谨慎地协调更多开发团队**
>     - 当部署服务**跨越多个服务**的功能时需要**谨慎地协调更多开发团队**。**必须制定一个`发布计划`**，把服务按照依赖关系进行排序。这跟单体架构下批量部署多个组件的方式截然不同。

* * *

> - **开发者需要思考到底应该在应用的什么阶段使用微服务架构**
>     - 使用微服务架构的另一个问题是决定在应用程序生命周期的哪个阶段开始使用这种架构。在开发应用程序的第一个版本时，你通常不会遇到需要微服务架构才能解决的问题。此外，**使用精心设计的分布式架构将`减缓开发速度`**。这对初创公司来说可能是得不偿失的，微服务架构使得项目开始阶段的快速迭代变得非常困难。初创公司几乎肯定应该从单体的应用程序开始，**`因为初创公司的初版应用程序是用为获取市场或投资人的反馈、进行快速试错的，这个阶段不应花费太多时间在微服务架构这样的事情上`。**

* * *

* * *

* * *

每项技术都有它的**弊端和限制**，这些总是被它们的鼓吹者所忽视。因此，某些技术的应用通常都会跟**光环曲线**一样先抑后扬。 [![](http://qiniu.dev-share.top/image/jpg/%E5%85%89%E7%8E%AF%E6%9B%B2%E7%BA%BF.jpg)](http://qiniu.dev-share.top/image/jpg/%E5%85%89%E7%8E%AF%E6%9B%B2%E7%BA%BF.jpg) **因此，`盲目的鼓吹`微服务架构是`非常不好`的。** **当然，把微服务架构`拒之千里`之外似乎也`不是什么明智之举`。**

* * *

* * *

* * *

### 服务拆分的相关模式

**有两种分解模式**：

- 根据业务能力拆分，围绕业务功能组织服务。
- 根据子域分解，子域围绕**领域驱动设计**(**DDD**)，来组织服务。

> - **通信的相关模式**
>     - **通信风格**：使用哪一类**进程间通信**机制？
>     - **服务发现**：客户端如何获得**服务**具体实例（如HTTP请求）的**IP地址**？
>     - **可靠性**：在服务不可用的情况下，如何确保**服务之间**的**可靠通信**？
>     - **事务性消息**：如何将消息发送、事件发布这样的动作与更新业务数据的**数据库事务**集成？
>     - **外部API**：应用程序的客户端如何与服务进行通信？

* * *

### 微服务之上：流程和组织

> - 对于大型和复杂的应用程序，微服务架构往往是最佳的选择。然而，除了拥有正确的架构之外，成功的软件开发还需要在**组织**、**开发**和**交付**流程方面做一些工作。
> - 成功往往意味着研发团队规模的扩大。一方面，这是个好事，因为人多力量大。但是，如果 **`团队太大`**，**`沟通成本过高`**， 往往会使得**团队的效率降低**。
> - 解决之道就是把大团队拆分成一系列小团队。每个团队都足够小，人员规模为 **8 ~ 12** 人。**每个团队都有一个`明确的职责`**。这些团队都是跨职能的。他们可以 **独立地完成`开发`、`测试`和`部署`** 等任务，而不需要频繁地与其他团队沟通或者协调。

* * *

> - 采用微服务架构以后，如果仍旧沿用瀑布式开发流程，那就跟用一匹马来拉法拉利跑车没什么区别
> - 我们需要充分利用**敏捷开发**和**持续交付**
>     - **持续交付**能够以可持续的方式，安全、快速地将所有类型的更改交付到生产环境或用户手中。
> - 采用微服务以后，**不仅改变了技术架构，也改变了组织结构和开发的流程**。归根到底，这是对工作环境中的人进行的一系列改变。

* * *

* * *

* * *

### 微服务是否拆分-个人学习总结

> 简单的来讲，是否要使用微服务，与你的业务和钱相关，投入合理的资金，换取你期望的利益。
> 
> 1. 假如你的产品一开始用户访问量很低，那么都没有必要使用微服务，更**推荐单体应用**，没必要浪费资源
> 2. 因为你的**市场营销做的不错**，用户量开始增加，原本的单体应用无法支撑你的业务，那么我们就要继续投入资源，来保证产品的正常运行
>     - 根据数据埋点，确定用户主要的访问业务模块，找出那个访问比较量大的业务模块，将它与原应用程序进行分离，并给它独力的资源运行
>     - 剩余的其它功能仍然放在一起运行
> 3. 因为你的产品**市场营销做的不错**做的越来越好，公司决定加大投入，要吸引更多的用户，产品中加入了大量的优惠活动
>     - 因为产品初期的活动少，所以应用程序还是在大单体中运行，由于公司的策略改变，大单体应用所使用的资源也不能支撑继续运行下去，经常出现卡顿、速度慢等情况，客户体验也很差
>     - 所以我们还要继续拆分，把属于活动的这部分应用给它独立的资源，但是新的问题来了，活动相关的其它的业务功能都很紧密，与其它的服务还有保持**RPC通信**，所以我们还需要引**微服务架构的解决方案**，来解决这个问题
> 4. 产品越做越大，越做越好，用户量越来越多，数据量不断增长，**节假日**与**工作日**所需要的**资源差异**也非常大，我们要如何管理这些**用户的数据**和**更合理的使用资源**
>     - 用户数据可以采用分布式数据库来存储，动态扩容
>     - 对于资源的使用，我们先让应用容器化，再采用云平台的**Kubernetes**来管理应用，**实现动态的资源申请和释放**
>     - 还可以采用**serverless**按需使用资源，用完即释放

| 用户使用量 | 运行时间 | 每月访问人数 | 技术架构 |
| --- | --- | --- | --- |
| 小 | 1个月 | 100 ~ 1000 | 前端：(前后台分离)  
后端：大单体应用  
数据库：MySQL |
| 中 | 6个月 | 1000 ~ 1万 | 前端：(前后台分离)  
后端：大单体应用 + 高并发业务应用  
数据库：MySQL |
| 大 | 12个月 | 10万 ~ 100万 | 前端：(前后台分离)  
后端：微服务多个小单体应用  
数据库：MySQL + 高可用 |
| 超大 | 18个月 | 100万 ~ 200万 | 前端：(前后台分离 + 微前端)  
后端：微服务容器化 + Kubernetes管理  
数据库：分布式数据库 |

* * *

* * *

* * *

### **微服务拆分思路整理**

- 需要即懂业务又懂业务代码的人，来把控微服务拆分的粒度与评估拆分的风险
    
    - 需要这个人找出程序中业务代码的可分离点，也就是说他要评估拆分的是否合理
- 需要客户提供，架构图、用例图、业务流程图
- 先保证运行环境的改变，不对应用程序做过度拆分
- 如果团队都是新人接手，很容易会把业务逻辑改坏，对于程序员来说，是不敢动手的，我们有过实际经历
- 一开始的改造，只做了一些删除的功能，不会做大量的改造
    
    1. 通常只有新增加的业务程序，才是完全相符的
    2. 先搞运行环境
    3. 删除无用的功能
    4. 尝试分离业务相关联最少的模块
    5. 迭代拆分
